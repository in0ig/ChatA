# ChatBI 开发规则

## 项目上下文

这是一个 ChatBI（智能数据分析对话系统）项目：
- **前端**: Vue 3 + Pinia + Element Plus + Vitest
- **后端**: FastAPI + MySQL + Qwen
- **目标**: 复刻腾讯云 ChatBI 核心界面与功能

## 开发规范

### 代码风格
- 使用 TypeScript 严格模式
- Vue 组件使用 Composition API (`<script setup>`)
- 使用 Pinia 进行状态管理
- 遵循 Vue 3 最佳实践

### 测试要求
- 每个组件必须有对应的测试文件
- 测试文件位置: `frontend/tests/unit/`
- 使用 Vitest + Vue Test Utils
- 测试覆盖率目标: ≥ 80%
- **🔒 测试标准预定义原则**：
  - 任务开始前必须明确定义所有测试用例
  - 测试标准一旦定义，不允许因实现困难而降低
  - 禁止删除或简化预定义的测试用例
  - 禁止修改验证通过标准以"适应"实现

### 命名规范
- 组件文件: PascalCase (如 `MessageStream.vue`)
- Store 文件: camelCase (如 `chat.ts`)
- 测试文件: 与源文件同名 + `.test.ts` (如 `MessageStream.test.ts`)

### 文件组织
```
frontend/
├── src/
│   ├── components/
│   │   ├── Chat/          # 对话相关组件
│   │   ├── Navigation/    # 导航相关组件
│   │   └── Config/        # 配置相关组件
│   ├── views/             # 页面组件
│   ├── store/
│   │   └── modules/       # Pinia stores
│   └── router/
└── tests/
    └── unit/              # 单元测试
```

## 任务执行规则

### 执行前检查
1. 阅读 `.kiro/specs/chatbi-vue-implementation/` 下的 requirements.md、design.md、tasks.md
2. 确认当前任务的依赖任务已完成
3. 理解任务的验收标准
4. **🔒 预定义测试标准**：
   - 明确定义所有必需的测试用例
   - 设定测试覆盖率要求（≥ 80%）
   - 确定验证通过标准（100% 测试通过）
   - 制定功能验收清单
5. **🌐 前端浏览器验证要求（使用 Chrome Connector MCP）**：
   - **在开发前必须与用户确认验证要求**
   - 明确需要验证的页面路径和功能点
   - 确定验证的具体操作步骤和预期结果
   - 获得用户批准后再开始开发

### 执行中规范
1. **一次只执行一个任务** - 完成后停止，等待用户确认
2. **先写代码，后写测试** - 确保功能实现后再编写测试
3. **运行测试验证** - 使用 `npm run test -- --run` 验证所有测试通过（必须使用 --run 避免 watch 模式卡住）
4. **检查 TypeScript 错误** - 确保无类型错误

### 执行后验证
1. 运行 `npm run test -- --run` 确保所有测试通过（使用 --run 避免 watch 模式）
2. 检查是否满足任务的所有验收标准
3. **🌐 使用 Chrome Connector MCP 进行浏览器验证**：
   - 启动前端开发服务器（如果尚未启动）
   - 使用 Chrome Connector MCP 工具打开浏览器
   - 导航到相关页面并执行预定义的验证步骤
   - 验证所有功能点是否按预期工作
   - 截图记录关键验证结果
   - 检查浏览器控制台是否有错误
4. 更新 tasks.md 中的任务状态（标记为 [x]）
5. 向用户报告完成情况（包含浏览器验证结果）

## API 调用规范

### 后端 API 基础路径
- 开发环境: `http://localhost:8000`
- API 前缀: `/api`

### 常用端点
- 会话管理: `/api/sessions`
- 查询处理: `/api/query`
- 数据源管理: `/api/datasources`
- 数据准备: `/api/data-prep`

### 错误处理
- 使用 try-catch 包裹 API 调用
- 失败时通过 UI Store 显示 Toast 提示
- 记录错误日志到 console

## 协作模式

### 角色分工

**Kiro (我) = 开发者**
- ✅ 读取和理解任务需求
- ✅ 直接编写代码和测试
- ✅ 验证任务完成质量
- ✅ 运行测试并检查结果
- ✅ 发现问题并直接修复
- ✅ **直接编写代码**

### 工作流程

1. 用户说"继续"或"执行任务 X"
2. 我读取 tasks.md 找到下一个未完成的任务
3. 我理解任务需求和验收标准
4. 我直接实现任务：编写代码、创建测试、确保质量
5. 我验证代码质量、运行测试
6. 如果有问题，我直接修复
7. 确认无误后，向用户报告完成情况

详细规则参见：`.kiro/steering/supervisor-rules.md`

## 重要提醒

- ⚠️ **不要跳过测试** - 每个任务都必须包含测试
- ⚠️ **不要一次执行多个任务** - 完成一个任务后停止
- ⚠️ **不要假设 API 已实现** - 如果后端 API 不存在，先 Mock 数据
- ⚠️ **使用中文注释** - 代码注释和文档使用简体中文
- 🔒 **测试标准不可妥协** - 预定义的测试标准绝对不能降低
- 🚨 **零容忍政策** - 对试图降低测试标准的行为零容忍
- 🌐 **前端必须浏览器验证** - 所有前端变更必须使用 Chrome Connector MCP 进行实际浏览器验证

## Chrome Connector MCP 验证流程

### 验证前准备
1. **与用户确认验证计划**：
   - 列出需要验证的页面路径（如 `/data-prep/datasources`）
   - 说明需要验证的功能点（如"创建数据源"、"测试连接"）
   - 描述具体的操作步骤（如"点击新建按钮 → 填写表单 → 点击保存"）
   - 明确预期结果（如"数据源列表中出现新记录"）
   - **等待用户批准后再开始开发**

2. **确保开发环境就绪**：
   - 前端开发服务器运行在 `http://localhost:5173`
   - 后端 API 服务器运行在 `http://localhost:8000`
   - 数据库服务正常运行

### 验证执行步骤

#### 1. 启动浏览器会话
```
使用 mcp_chrome_connector_list_pages 查看当前页面
使用 mcp_chrome_connector_new_page 打开新页面（如果需要）
```

#### 2. 导航到目标页面
```
使用 mcp_chrome_connector_navigate_page 导航到前端应用
URL: http://localhost:5173/[页面路径]
```

#### 3. 获取页面快照
```
使用 mcp_chrome_connector_take_snapshot 获取页面元素结构
分析页面中的交互元素（按钮、输入框、表格等）
```

#### 4. 执行交互操作
```
使用 mcp_chrome_connector_click 点击按钮
使用 mcp_chrome_connector_fill 填写表单
使用 mcp_chrome_connector_wait_for 等待元素出现
```

#### 5. 验证结果
```
使用 mcp_chrome_connector_take_snapshot 获取操作后的页面状态
使用 mcp_chrome_connector_take_screenshot 截图记录关键状态
使用 mcp_chrome_connector_list_console_messages 检查控制台错误
```

#### 6. 记录验证结果
- 截图保存到项目根目录（命名格式：`verification_[功能名]_[时间戳].png`）
- 记录所有验证步骤和结果
- 标注任何发现的问题或异常

### 验证报告模板

完成验证后，向用户提供以下格式的报告：

```markdown
## 浏览器验证报告

### 验证环境
- 前端地址: http://localhost:5173
- 验证页面: [页面路径]
- 验证时间: [时间戳]

### 验证内容
1. **功能点 1**: [功能描述]
   - 操作步骤: [详细步骤]
   - 预期结果: [预期]
   - 实际结果: ✅ 通过 / ❌ 失败
   - 截图: [截图文件名]

2. **功能点 2**: [功能描述]
   - 操作步骤: [详细步骤]
   - 预期结果: [预期]
   - 实际结果: ✅ 通过 / ❌ 失败
   - 截图: [截图文件名]

### 控制台检查
- ✅ 无错误 / ❌ 发现错误: [错误详情]

### 验收结论
- ✅ 所有验证通过，功能正常
- ❌ 发现问题，需要修复: [问题列表]
```

### 常见验证场景

#### 场景 1: 表单提交验证
1. 打开包含表单的页面
2. 填写表单字段
3. 点击提交按钮
4. 验证提交成功提示
5. 验证数据是否正确保存（刷新页面检查）

#### 场景 2: 列表数据验证
1. 打开列表页面
2. 验证数据是否正确加载
3. 测试搜索/筛选功能
4. 测试分页功能
5. 验证数据展示格式

#### 场景 3: 交互功能验证
1. 打开功能页面
2. 执行交互操作（点击、拖拽、输入等）
3. 验证 UI 响应
4. 验证状态变化
5. 验证数据更新

### 验证失败处理

如果验证失败：
1. 记录详细的错误信息和截图
2. 分析失败原因（前端代码、后端 API、数据问题）
3. 修复问题
4. 重新运行验证
5. 确保所有验证通过后再向用户报告

### 注意事项

- ⚠️ **每次前端代码变更后都必须进行浏览器验证**
- ⚠️ **验证前必须与用户确认验证计划**
- ⚠️ **验证失败必须修复后才能标记任务完成**
- ⚠️ **保存所有验证截图作为完成证据**
- ⚠️ **检查浏览器控制台，确保无 JavaScript 错误**
