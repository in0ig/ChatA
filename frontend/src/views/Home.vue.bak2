<template>
  <div class="home-container">
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="toolbar">
      <div class="toolbar-left">
        <div class="toolbar-item">
          <el-switch
            v-model="dataInterpretation"
            active-text="æ•°æ®è§£è¯»"
            inactive-text=""
            :active-color="'#1890ff'"
            :inactive-color="'#ccc'"
            size="small"
          />
        </div>
        
        <div class="toolbar-item">
          <el-switch
            v-model="fluctuationAnalysis"
            active-text="æ³¢åŠ¨å½’å› "
            inactive-text=""
            :active-color="'#1890ff'"
            :inactive-color="'#ccc'"
            size="small"
          />
        </div>
      </div>
      
      <!-- å³ä¾§é…ç½®æŒ‰é’® -->
      <div class="toolbar-right">
        <el-button 
          class="config-button" 
          @click="toggleConfigDrawer"
        >
          <el-icon style="margin-right: 4px;"><Setting /></el-icon>
          é…ç½®
        </el-button>
      </div>
    </div>

    <!-- æ¬¢è¿è¯­å’Œæ¨èé—®é¢˜ -->
    <div class="welcome-section" v-if="!hasActiveSession">
      <div class="welcome-header">
        <h1>æ¬¢è¿ä½¿ç”¨ ChatBI</h1>
        <p>è®©æ¯ä¸ªäººéƒ½èƒ½åƒå¯¹è¯ä¸€æ ·åˆ†ææ•°æ®</p>
      </div>
      
      <div class="recommended-questions">
        <h3>æ¨èé—®é¢˜</h3>
        <div class="question-list">
          <button 
            v-for="(question, index) in recommendedQuestions" 
            :key="index" 
            class="question-btn"
            @click="selectRecommendedQuestion(question)"
          >
            {{ question }}
          </button>
        </div>
      </div>
    </div>

    <!-- æ¶ˆæ¯æµåŒºåŸŸ -->
    <div class="messages-container" v-else>
      <div class="messages-list">
        <!-- æ•°æ®æºåŠ è½½ä¸­çŠ¶æ€ -->
        <div v-if="isLoading && !error" class="message ai-message">
          <div class="avatar ai-avatar">ğŸ¤–</div>
          <div class="message-content ai-content">
            <div class="loading-indicator">
              <div class="loading-dots">
                <span>.</span>
                <span>.</span>
                <span>.</span>
              </div>
              <p>æ­£åœ¨åŠ è½½æ•°æ®æº...</p>
            </div>
          </div>
        </div>
        
        <!-- æ•°æ®æºåŠ è½½é”™è¯¯çŠ¶æ€ -->
        <div v-else-if="error" class="message ai-message">
          <div class="avatar ai-avatar">ğŸ¤–</div>
          <div class="message-content ai-content">
            <p class="error-message">{{ error }}</p>
          </div>
        </div>
        
        <!-- æ­£å¸¸æ¶ˆæ¯åˆ—è¡¨ -->
        <div 
          v-for="message in messages" 
          :key="message.id"
          v-show="!isLoading || error"
        >
          <!-- ç”¨æˆ·æ¶ˆæ¯ -->
          <div v-if="message.role === 'user'" class="message user-message">
            <div class="avatar user-avatar">ğŸ‘¤</div>
            <div class="message-content user-content">
              <p>{{ message.content }}</p>
              <div class="message-actions">
                <button class="action-btn" @click="refreshMessage(message)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                </button>
                <button class="action-btn" @click="likeMessage(message)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>
                </button>
                <button class="action-btn" @click="dislikeMessage(message)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/></svg>
                </button>
              </div>
            </div>
          </div>
          
          <!-- AI æ¶ˆæ¯ -->
          <div v-else class="message ai-message">
            <div class="avatar ai-avatar">ğŸ¤–</div>
            <div class="message-content ai-content">
              <p v-if="message.content" v-html="formatContent(message.content)"></p>
              
              <!-- å›¾è¡¨æ˜¾ç¤º -->
              <div v-if="message.chartType" class="chart-container">
                <ChartRenderer 
                  :chart-title="message.chartTitle || ''" 
                  :data="message.chartData" 
                  :max-value="message.maxValue"
                />
              </div>
              
              <!-- æ•°æ®è¡¨æ ¼æ˜¾ç¤º -->
              <div v-if="message.tableData" class="table-container">
                <DataTable 
                  :headers="message.tableHeaders || []" 
                  :rows="message.tableData"
                />
              </div>
              
              <!-- æ“ä½œæŒ‰é’® -->
              <div class="message-actions">
                <button class="action-btn" @click="refreshMessage(message)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                </button>
                <button class="action-btn" @click="likeMessage(message)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>
                </button>
                <button class="action-btn" @click="dislikeMessage(message)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/></svg>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- åŠ è½½çŠ¶æ€ -->
        <div v-if="uiStore.isLoading" class="message ai-message">
          <div class="avatar ai-avatar">ğŸ¤–</div>
          <div class="message-content ai-content">
            <div class="loading-indicator">
              <div class="loading-dots">
                <span>.</span>
                <span>.</span>
                <span>.</span>
              </div>
              <p>{{ uiStore.loadingMessage }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨è¾“å…¥æ§åˆ¶åŒº -->
    <div class="input-container">
        <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ è¾“å…¥ -->
        <input 
          type="file" 
          id="file-upload" 
          style="display: none;" 
          @change="handleFileUpload" 
          accept=".csv,.xlsx,.xls,.txt,.json" 
        />
        
        <!-- ç¬¬ä¸€è¡Œï¼šæ•°æ®æºé€‰æ‹©å™¨ã€æ¨¡å¼åˆ‡æ¢å¼€å…³ -->
        <div class="input-row" style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <div class="data-source-selector" style="display: flex; align-items: center;">
            <label class="label">æ•°æ®æºï¼š</label>
            <el-select 
              v-model="currentDataSource" 
              placeholder="è¯·é€‰æ‹©æ•°æ®æº" 
              class="source-select"
              @change="handleDataSourceChange"
            >
              <el-option 
                v-for="item in dataSources" 
                :key="item.id" 
                :label="item.name" 
                :value="item.id" 
              />
            </el-select>
          </div>
          
          <div class="mode-toggle" style="display: flex; align-items: center; margin-left: auto;">
            <label class="label" style="margin-right: 8px;">æ™ºèƒ½é—®æ•°</label>
            <el-switch
              v-model="chatMode"
              active-text=""
              inactive-text=""
              :active-color="'#1890ff'"
              :inactive-color="'#ccc'"
              size="small"
              @change="toggleChatMode"
            />
            <label class="label" style="margin-left: 8px;">ç”ŸæˆæŠ¥å‘Š</label>
          </div>
        </div>
        
        <!-- ç¬¬äºŒè¡Œï¼šæ•°æ®è¡¨é€‰æ‹©å™¨ã€é¢„è§ˆæŒ‰é’® -->
        <div class="input-row" style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <div class="data-table-selector" style="display: flex; align-items: center; flex: 1;">
            <label class="label">æ•°æ®è¡¨ï¼š</label>
            <el-select 
              v-model="currentDataTables" 
              placeholder="è¯·é€‰æ‹©æ•°æ®è¡¨" 
              class="table-select"
              multiple
              collapse-tags
              collapse-tags-tooltip
              :disabled="!currentDataSource"
              @change="handleDataTableChange"
            >
              <el-option 
                v-for="item in availableDataTables" 
                :key="item.id" 
                :label="item.name" 
                :value="item.id" 
              />
            </el-select>
          </div>
          
          <el-button 
            type="primary" 
            size="small" 
            class="preview-btn"
            :disabled="!currentDataTables || currentDataTables.length === 0"
            @click="openDataTablePreview"
          >
            é¢„è§ˆ
          </el-button>
        </div>
        
        <!-- å•è¡Œï¼šå æ»¡å®½åº¦çš„æ–‡æœ¬è¾“å…¥æ¡† -->
        <div class="input-row">
          <el-input
            v-model="inputText"
            :placeholder="'è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œè®© AI åˆ†ææ•°æ®...'"
            type="textarea"
            :autosize="{ minRows: 2, maxRows: 6 }"
            class="message-input"
            @keydown.enter.exact.prevent="sendMessage"
            @keydown.enter.shift="handleShiftEnter"
          />
        </div>      
      <!-- å•è¡Œï¼šé™„ä»¶æŒ‰é’®å’Œå‘é€æŒ‰é’®å³å¯¹é½ -->
      <div class="input-row" style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 12px;">
        <!-- é™„ä»¶æŒ‰é’® - ä½¿ç”¨ SVG å›¾æ ‡ -->
        <button 
          type="button" 
          class="custom-btn attachment-btn" 
          @click="uploadFile"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
          </svg>
        </button>
        
        <!-- å‘é€æŒ‰é’® - ä½¿ç”¨ SVG å›¾æ ‡ -->
        <button 
          type="button" 
          class="custom-btn send-btn" 
          :disabled="!canSend"
          @click="sendMessage"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
          </svg>
        </button>
      </div>
    </div>
    
    <!-- æ•°æ®æºé€‰æ‹©å¼¹çª— -->
    <DataSourceSelector
      v-model="dataSourceSelectorVisible"
      :data-sources="dataSources"
      :is-loading="isLoading"
      :error="error"
      @confirm="handleDataSourceConfirm"
      @preview="handleDataSourcePreview"
      @retry="handleDataSourceRetry"
    />
    
    <!-- æ•°æ®é¢„è§ˆæ¨¡æ€æ¡† -->
    <DataPreviewModal
      v-model="dataPreviewModalVisible"
      :preview-data="previewData"
      :is-multi-table="isMultiTable"
      :selected-tables="selectedTablesForPreview"
      @table-change="handlePreviewTableChange"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, reactive } from 'vue'
import { useChatStore } from '@/store/modules/chat'
import { useUIStore } from '@/store/modules/ui'
import { useRoute } from 'vue-router'
import { Setting } from '@element-plus/icons-vue'
import ChartRenderer from '@/components/ChartRenderer.vue'
import DataTable from '@/components/DataTable.vue'
import DataSourceSelector from '@/components/DataSource/DataSourceSelector.vue'
import DataPreviewModal from '@/components/DataSource/DataPreviewModal.vue'
import { useDataPrepStore } from '@/store/modules/dataPrep'

const chatStore = useChatStore()
const uiStore = useUIStore()
const route = useRoute()

// é…ç½®æŠ½å±‰æ§åˆ¶
const toggleConfigDrawer = () => {
  uiStore.toggleConfigDrawer()
}

// çŠ¶æ€
const inputText = ref('')
const currentDataSource = ref('')
const currentDataTables = ref<string[]>([])
const chatMode = ref('query')
const dataInterpretation = ref(true)
const fluctuationAnalysis = ref(false)

// æ•°æ®æºé€‰æ‹©å¼¹çª—çŠ¶æ€
const dataSourceSelectorVisible = ref(false)
const dataPreviewModalVisible = ref(false)
const previewData = ref({
  schema: [],
  data: []
})
const isMultiTable = ref(false)

const selectedTablesForPreview = ref([])// è·å–æ•°æ®æºåˆ—è¡¨
const dataPrepStore = useDataPrepStore()
const dataSources = computed(() => {
  return dataPrepStore.dataSources
})


// æ ¹æ®é€‰ä¸­çš„æ•°æ®æºè·å–å¯ç”¨çš„æ•°æ®è¡¨
const availableDataTables = computed(() => {
  if (!currentDataSource.value) {
    return []
  }
  return dataPrepStore.getDataTablesBySourceId(currentDataSource.value) || []
})// åŠ è½½çŠ¶æ€å’Œé”™è¯¯å¤„ç†
const isLoading = computed(() => {
  return dataPrepStore.isLoadingDataSources || uiStore.isLoading
})

const error = computed(() => {
  return dataPrepStore.dataSourceError
})

// æ¨èé—®é¢˜
const recommendedQuestions = ref([
  '2023å¹´å„å•†å“ç±»åˆ«çš„é”€å”®é¢æ˜¯å¤šå°‘ï¼Ÿ',
  '2024å¹´æ¯›åˆ©æœ€é«˜çš„äº§å“æ˜¯ä»€ä¹ˆï¼Ÿ',
  'æœ€è¿‘7å¤©çš„é”€å”®è¶‹åŠ¿å¦‚ä½•ï¼Ÿ',
  'å„åŒºåŸŸçš„é”€å”®å¯¹æ¯”æƒ…å†µ',
  'å®¢æˆ·è½¬åŒ–ç‡çš„å˜åŒ–è¶‹åŠ¿'
])

// æ¶ˆæ¯åˆ—è¡¨
const messages = computed(() => {
  return chatStore.messages
})

// æ˜¯å¦æœ‰æ´»è·ƒä¼šè¯ï¼ˆæœ‰æ¶ˆæ¯æ—¶æ˜¾ç¤ºæ¶ˆæ¯æµï¼Œå¦åˆ™æ˜¾ç¤ºæ¬¢è¿é¡µï¼‰
const hasActiveSession = computed(() => {
  return messages.value && messages.value.length > 0
})

// è¾“å…¥æ¡†å ä½ç¬¦
const inputPlaceholder = computed(() => {
  if (!currentDataSource.value) {
    return 'è¯·å…ˆé€‰æ‹©æ•°æ®æº...'
  }
  return chatMode.value === 'query' 
    ? 'è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œè®© AI åˆ†ææ•°æ®...' 
    : 'è¾“å…¥æ‚¨æƒ³è¦ç”Ÿæˆçš„æŠ¥å‘Šå†…å®¹...'
})

// æ˜¯å¦å¯ä»¥å‘é€æ¶ˆæ¯
const canSend = computed(() => {
  return inputText.value.trim().length > 0 && currentDataSource.value
})

// æ ¼å¼åŒ–å†…å®¹ï¼ˆå¤„ç†æ¢è¡Œå’Œé“¾æ¥ï¼‰
const formatContent = (content) => {
  if (!content) return ''
  return content.replace(/\n/g, '<br>')
}

// å¤„ç†å›è½¦é”®
const handleShiftEnter = (event) => {
  // å…è®¸ Shift+Enter æ’å…¥æ¢è¡Œ
  event.preventDefault()
  const textarea = event.target
  const start = textarea.selectionStart
  const end = textarea.selectionEnd
  const text = textarea.value
  textarea.value = text.substring(0, start) + '\n' + text.substring(end)
  textarea.selectionStart = textarea.selectionEnd = start + 1
}

// é€‰æ‹©æ¨èé—®é¢˜
const selectRecommendedQuestion = (question) => {
  inputText.value = question
}

// æ•°æ®æºå˜æ›´
const handleDataSourceChange = async (value: string | null) => {
  currentDataSource.value = value
  // æ¸…ç©ºæ•°æ®è¡¨é€‰æ‹©
  currentDataTables.value = []
  
  // æ›´æ–° chatStoreï¼ˆéœ€è¦ä¼ é€’æ•°ç»„æ ¼å¼ä»¥ä¿æŒå…¼å®¹æ€§ï¼‰
  chatStore.setDataSource(value ? [value] : [])
  
  // åŠ è½½é€‰ä¸­æ•°æ®æºä¸‹çš„æ•°æ®è¡¨
  if (value) {
    await dataPrepStore.loadDataTables(value)
  }
}


// æ•°æ®è¡¨å˜æ›´
const handleDataTableChange = (values) => {
  currentDataTables.value = values
  chatStore.setDataTables(values)
}

// æ‰“å¼€æ•°æ®è¡¨é¢„è§ˆ
const openDataTablePreview = () => {
  // è·å–é€‰ä¸­çš„æ•°æ®è¡¨ä¿¡æ¯
  const selectedTables = availableDataTables.value.filter(table =>
    currentDataTables.value.includes(table.id)
  )
  
  if (selectedTables.length === 0) {
    ElMessage.warning('è¯·å…ˆé€‰æ‹©æ•°æ®è¡¨')
    return
  }
  
  // è®¾ç½®é€‰ä¸­çš„è¡¨åˆ—è¡¨ä¾›é¢„è§ˆæ¨¡æ€æ¡†ä½¿ç”¨
  selectedTablesForPreview.value = selectedTables
  
  // å¦‚æœåªé€‰æ‹©äº†ä¸€å¼ è¡¨ï¼Œç›´æ¥é¢„è§ˆ
  if (selectedTables.length === 1) {
    isMultiTable.value = false
    handleDataSourcePreview(selectedTables[0])
  } else {
    // å¤šå¼ è¡¨ï¼Œæ˜¾ç¤ºé€‰æ‹©å¯¹è¯æ¡†
    isMultiTable.value = true
    // é»˜è®¤é¢„è§ˆç¬¬ä¸€å¼ è¡¨
    handleDataSourcePreview(selectedTables[0])
  }
  
  // æ‰“å¼€é¢„è§ˆæ¨¡æ€æ¡†
  dataPreviewModalVisible.value = true
}

// å¤„ç†é¢„è§ˆè¡¨åˆ‡æ¢
const handlePreviewTableChange = (tableId) => {
  // æ ¹æ®è¡¨IDæ‰¾åˆ°å¯¹åº”çš„è¡¨å¯¹è±¡
  const table = selectedTablesForPreview.value.find(t => t.id === tableId)
  if (table) {
    handleDataSourcePreview(table)
  }
}

// æ‰“å¼€æ•°æ®æºé€‰æ‹©å¼¹çª—

// å¤„ç†æ•°æ®æºé€‰æ‹©ç¡®è®¤
const handleDataSourceConfirm = (selectedTables) => {
  // æ›´æ–°å½“å‰é€‰æ‹©çš„æ•°æ®æº
  currentDataSource.value = selectedTables.map(table => table.id)
  chatStore.setDataSource(currentDataSource.value)
  dataSourceSelectorVisible.value = false
}

// å¤„ç†æ•°æ®æºé¢„è§ˆ
  dataPrepStore.resetDataSourceState()
  dataPrepStore.loadDataSources()
}

// ä¸Šä¼ å›¾ç‰‡
const uploadImage = () => {
  console.log('ä¸Šä¼ å›¾ç‰‡')
}

// ä¸Šä¼ æ–‡ä»¶
const uploadFile = () => {
  const fileInput = document.getElementById('file-upload')
  if (fileInput) {
    fileInput.click()
  }
}

// å¤„ç†æ–‡ä»¶ä¸Šä¼ 
const handleFileUpload = (event) => {
  const file = event.target.files[0]
  if (file) {
    // éªŒè¯æ–‡ä»¶ç±»å‹
    const allowedTypes = ['.csv', '.xlsx', '.xls', '.txt', '.json']
    const fileExtension = file.name.substring(file.name.lastIndexOf('.'))
    
    if (!allowedTypes.includes(fileExtension.toLowerCase())) {
      console.warn('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹:', file.name)
      alert('ä»…æ”¯æŒ .csv, .xlsx, .xls, .txt, .json æ–‡ä»¶æ ¼å¼')
      event.target.value = '' // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
      return
    }
    
    // åœ¨æ§åˆ¶å°æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
    console.log('ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯:', {
      name: file.name,
      size: file.size,
      type: file.type,
      lastModified: file.lastModified
    })
    
    // è¿™é‡Œå¯ä»¥è°ƒç”¨åç«¯ API ä¸Šä¼ æ–‡ä»¶
    // uploadFileToServer(file)
    
    // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
    event.target.value = ''
  }
}

// åˆ‡æ¢èŠå¤©æ¨¡å¼
const toggleChatMode = () => {
  chatStore.toggleChatMode()
}

// å‘é€æ¶ˆæ¯
const sendMessage = async () => {
  if (!canSend.value) return
  
  await chatStore.sendMessage(inputText.value)
  inputText.value = ''
}

// åˆ·æ–°æ¶ˆæ¯
const refreshMessage = (message) => {
  // å®ç°åˆ·æ–°é€»è¾‘
  console.log('åˆ·æ–°æ¶ˆæ¯:', message)
}

// ç‚¹èµæ¶ˆæ¯
const likeMessage = (message) => {
  // å®ç°ç‚¹èµé€»è¾‘
  console.log('ç‚¹èµæ¶ˆæ¯:', message)
}

// ç‚¹è¸©æ¶ˆæ¯
const dislikeMessage = (message) => {
  // å®ç°ç‚¹è¸©é€»è¾‘
  console.log('ç‚¹è¸©æ¶ˆæ¯:', message)
}

// åˆå§‹åŒ–
onMounted(() => {
  // åŠ è½½ä¼šè¯å’Œå†å²è®°å½•
  chatStore.loadSessions()
  chatStore.loadHistory()
  
  // åŠ è½½æ•°æ®æº
  dataPrepStore.loadDataSources()
  
  // è®¾ç½®é»˜è®¤æ•°æ®æºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  if (dataPrepStore.dataSources.length > 0) {
    const activeSource = dataPrepStore.dataSources.find(ds => ds.isActive)
    if (activeSource) {
      currentDataSource.value = [activeSource.id]
      chatStore.setDataSource([activeSource.id])
    } else {
      currentDataSource.value = [dataPrepStore.dataSources[0].id]
      chatStore.setDataSource([dataPrepStore.dataSources[0].id])
    }
  }
})
</script>

<style scoped>
.home-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  padding: 20px;
}

/* é¡¶éƒ¨å·¥å…·æ æ ·å¼ */
.toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 24px;
  margin-bottom: 24px;
  padding: 0 20px;
}

.toolbar-left {
  display: flex;
  align-items: center;
  gap: 24px;
}

.toolbar-right {
  display: flex;
  align-items: center;
}

.toolbar-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.config-button {
  display: flex;
  align-items: center;
  padding: 8px 16px;
  border: 1px solid #d9d9d9;
  background-color: #ffffff;
  color: #666;
  font-size: 14px;
  border-radius: 4px;
  transition: all 0.3s ease;
  cursor: pointer;
}

.config-button:hover {
  border-color: #1890ff;
  color: #1890ff;
}

.config-button .el-icon {
  font-size: 16px;
}

/* æ¬¢è¿é¡µé¢æ ·å¼ */
.welcome-section {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 40px 20px;
  color: #666;
}

.welcome-header h1 {
  font-size: 36px;
  font-weight: 700;
  color: #1890ff;
  margin-bottom: 10px;
}

.welcome-header p {
  font-size: 18px;
  color: #444;
  margin-bottom: 40px;
}

.recommended-questions {
  width: 100%;
  max-width: 600px;
}

.recommended-questions h3 {
  font-size: 18px;
  font-weight: 600;
  color: #333;
  margin-bottom: 20px;
  text-align: left;
}

.question-list {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

.question-btn {
  background-color: #f0f7ff;
  color: #1890ff;
  border: 1px solid #d0e7ff;
  padding: 10px 16px;
  border-radius: 20px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s ease;
  text-align: left;
}

.question-btn:hover {
  background-color: #1890ff;
  color: white;
  border-color: #1890ff;
}

/* æ¶ˆæ¯æµåŒºåŸŸæ ·å¼ */
.messages-container {
  flex: 1;
  overflow-y: auto;
  padding: 20px 0;
}

.messages-list {
  max-width: 800px;
  margin: 0 auto;
  width: 100%;
}

.message {
  display: flex;
  margin-bottom: 24px;
}

.user-message {
  flex-direction: row-reverse;
}

.ai-message {
  flex-direction: row;
}

.avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  margin-left: 16px;
}

.user-avatar {
  background-color: #1890ff;
  color: white;
}

.ai-avatar {
  background-color: #f0f0f0;
  color: #333;
}

.message-content {
  flex: 1;
  max-width: calc(100% - 56px);
}

.user-content {
  background-color: #f0f0f0;
  color: #333;
  padding: 16px;
  border-radius: 16px 16px 16px 0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.ai-content {
  background-color: white;
  color: #333;
  padding: 16px;
  border-radius: 16px 16px 0 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.message-content p {
  font-size: 16px;
  line-height: 1.6;
  margin: 0;
}

.message-content p:not(:last-child) {
  margin-bottom: 12px;
}

/* å›¾è¡¨å®¹å™¨ */
.chart-container {
  margin: 16px 0;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* æ•°æ®è¡¨æ ¼å®¹å™¨ */
.table-container {
  margin: 16px 0;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* æ¶ˆæ¯æ“ä½œæŒ‰é’® */
.message-actions {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.action-btn {
  background-color: #f0f0f0;
  color: #333;
  border: none;
  padding: 6px 12px;
  border-radius: 16px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.action-btn:hover {
  background-color: #e0e0e0;
}

/* åŠ è½½æŒ‡ç¤ºå™¨ */
.loading-indicator {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}

.loading-dots {
  display: flex;
  gap: 4px;
  margin-bottom: 8px;
}

.loading-dots span {
  width: 6px;
  height: 6px;
  background-color: #1890ff;
  border-radius: 50%;
  animation: bounce 1.4s infinite ease-in-out;
}

.loading-dots span:nth-child(2) {
  animation-delay: 0.2s;
}

.loading-dots span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}

/* åº•éƒ¨è¾“å…¥æ§åˆ¶åŒºæ ·å¼ */
.input-container {
  padding: 20px 0;
  border-top: 1px solid #eee;
}

.input-row {
  display: flex;
  align-items: center;
  padding: 0 20px;
  margin-bottom: 12px;
}

.data-source-selector {
  display: flex;
  align-items: center;
  margin-right: 16px;
}

.label {
  font-size: 14px;
  color: #666;
  margin-right: 8px;
}

.source-select {
  width: 180px;
}

.preview-btn {
  margin-right: 16px;
}

.mode-toggle {
  margin-left: auto;
}

.message-input {
  flex: 1;
  border-radius: 20px;
  border: 1px solid #ddd;
  padding: 12px 16px;
  font-size: 16px;
  resize: none;
}

.message-input:focus {
  outline: none;
  border-color: #1890ff;
  box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
}

/* Custom SVG buttons styles */
.custom-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background-color: #1890ff;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  padding: 0;
  color: white;
}

.custom-btn svg {
  color: white;
}

.attachment-btn:hover {
  background-color: #096dd9;
  transform: scale(1.05);
}

.send-btn:hover {
  background-color: #096dd9;
  transform: scale(1.05);
}

.send-btn:disabled {
  background-color: #f0f0f0;
  color: #999;
  cursor: not-allowed;
  transform: none;
}



/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .home-container {
    padding: 10px;
  }
  
  .toolbar {
    padding: 0 10px;
    gap: 16px;
  }
  
  .welcome-section {
    padding: 20px;
  }
  
  .welcome-header h1 {
    font-size: 28px;
  }
  
  .welcome-header p {
    font-size: 16px;
  }
  
  .question-list {
    gap: 8px;
  }
  
  .question-btn {
    padding: 8px 12px;
    font-size: 12px;
  }
  
  .input-row {
    flex-direction: column;
    align-items: flex-start;
    padding: 0 10px;
  }
  
  .data-source-selector {
    margin-right: 0;
    margin-bottom: 8px;
    width: 100%;
  }
  
  .source-select {
    width: 100%;
  }
  
  .preview-btn {
    margin-right: 0;
    margin-bottom: 8px;
    width: 100%;
  }
  
  .mode-toggle {
    margin-left: 0;
    margin-bottom: 8px;
    width: 100%;
  }
  
  .message-input {
    padding: 10px 14px;
    font-size: 14px;
    width: 100%;
  }
  
  .photo-btn, .attachment-btn, .send-btn {
    margin-left: 0;
    margin-top: 8px;
  }
}
</style>