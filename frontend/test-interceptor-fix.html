<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹¦æˆªå™¨ä¿®å¤æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; background: #f0f8f0; padding: 10px; border-radius: 3px; }
        .error { color: red; background: #fff0f0; padding: 10px; border-radius: 3px; }
        .info { color: blue; background: #f0f0ff; padding: 10px; border-radius: 3px; }
        button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>æ‹¦æˆªå™¨ä¿®å¤æµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>ä¿®å¤è¯´æ˜</h3>
        <div class="info">
            <p><strong>é—®é¢˜ï¼š</strong> å‰ç«¯æ‹¦æˆªå™¨å¯¹æ‰€æœ‰åŒ…å« `/datasources` çš„ URL éƒ½è¿›è¡Œ name å­—æ®µéªŒè¯</p>
            <p><strong>å½±å“ï¼š</strong> `/datasources/test` ä¹Ÿè¢«éªŒè¯ï¼Œä½†æµ‹è¯•è¿æ¥çš„è¯·æ±‚æ ¼å¼ä¸åŒ</p>
            <p><strong>ä¿®å¤ï¼š</strong> æ’é™¤ `/datasources/test` è·¯å¾„çš„éªŒè¯</p>
        </div>
    </div>

    <div class="test-section">
        <h3>æ‹¦æˆªå™¨é€»è¾‘æµ‹è¯•</h3>
        <button onclick="testOldLogic()">æµ‹è¯•ä¿®å¤å‰é€»è¾‘</button>
        <button onclick="testNewLogic()">æµ‹è¯•ä¿®å¤åé€»è¾‘</button>
        <button onclick="testCreateDataSource()">æµ‹è¯•åˆ›å»ºæ•°æ®æºï¼ˆåº”è¯¥éªŒè¯ï¼‰</button>
    </div>
    
    <div class="test-section">
        <h3>æµ‹è¯•ç»“æœ</h3>
        <div id="result"></div>
    </div>

    <script>
        function testOldLogic() {
            const resultDiv = document.getElementById('result');
            
            const config = {
                method: 'POST',
                url: '/api/datasources/test',
                data: {
                    name: 'demo_datasource',
                    source_type: 'DATABASE',
                    // ... å…¶ä»–å­—æ®µ
                }
            };

            try {
                // æ—§é€»è¾‘ï¼šå¯¹æ‰€æœ‰ /datasources è·¯å¾„éƒ½éªŒè¯
                if (config.method?.toUpperCase() === 'POST' || config.method?.toUpperCase() === 'PUT') {
                    if (config.data && typeof config.data === 'object') {
                        if (config.url?.includes('/datasources') && config.data.name === undefined) {
                            throw new Error('æ•°æ®æºåç§°ä¸èƒ½ä¸ºç©º');
                        }
                    }
                }

                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>âœ… æ—§é€»è¾‘æµ‹è¯•é€šè¿‡</h4>
                        <p>URL: ${config.url}</p>
                        <p>åŒ…å« /datasources: ${config.url?.includes('/datasources')}</p>
                        <p>name å­—æ®µ: ${config.data.name}</p>
                        <p>ç»“æœ: ä¸ä¼šæŠ›å‡ºé”™è¯¯ï¼ˆå› ä¸º name å­—æ®µå­˜åœ¨ï¼‰</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ æ—§é€»è¾‘æµ‹è¯•å¤±è´¥</h4>
                        <p>é”™è¯¯: ${error.message}</p>
                    </div>
                `;
            }
        }

        function testNewLogic() {
            const resultDiv = document.getElementById('result');
            
            const config = {
                method: 'POST',
                url: '/api/datasources/test',
                data: {
                    name: 'demo_datasource',
                    source_type: 'DATABASE',
                    // ... å…¶ä»–å­—æ®µ
                }
            };

            try {
                // æ–°é€»è¾‘ï¼šæ’é™¤ /datasources/test è·¯å¾„
                if (config.method?.toUpperCase() === 'POST' || config.method?.toUpperCase() === 'PUT') {
                    if (config.data && typeof config.data === 'object') {
                        if (config.url?.includes('/datasources') && 
                            !config.url?.includes('/datasources/test') && 
                            config.data.name === undefined) {
                            throw new Error('æ•°æ®æºåç§°ä¸èƒ½ä¸ºç©º');
                        }
                    }
                }

                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>âœ… æ–°é€»è¾‘æµ‹è¯•é€šè¿‡</h4>
                        <p>URL: ${config.url}</p>
                        <p>åŒ…å« /datasources: ${config.url?.includes('/datasources')}</p>
                        <p>åŒ…å« /datasources/test: ${config.url?.includes('/datasources/test')}</p>
                        <p>name å­—æ®µ: ${config.data.name}</p>
                        <p>ç»“æœ: è·³è¿‡éªŒè¯ï¼ˆå› ä¸ºæ˜¯æµ‹è¯•è¿æ¥è·¯å¾„ï¼‰</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ æ–°é€»è¾‘æµ‹è¯•å¤±è´¥</h4>
                        <p>é”™è¯¯: ${error.message}</p>
                    </div>
                `;
            }
        }

        function testCreateDataSource() {
            const resultDiv = document.getElementById('result');
            
            const configWithName = {
                method: 'POST',
                url: '/api/datasources',
                data: {
                    name: 'test_datasource',
                    type: 'mysql'
                }
            };

            const configWithoutName = {
                method: 'POST',
                url: '/api/datasources',
                data: {
                    type: 'mysql'
                    // ç¼ºå°‘ name å­—æ®µ
                }
            };

            let results = [];

            // æµ‹è¯•æœ‰ name å­—æ®µçš„æƒ…å†µ
            try {
                if (configWithName.method?.toUpperCase() === 'POST' || configWithName.method?.toUpperCase() === 'PUT') {
                    if (configWithName.data && typeof configWithName.data === 'object') {
                        if (configWithName.url?.includes('/datasources') && 
                            !configWithName.url?.includes('/datasources/test') && 
                            configWithName.data.name === undefined) {
                            throw new Error('æ•°æ®æºåç§°ä¸èƒ½ä¸ºç©º');
                        }
                    }
                }
                results.push('âœ… æœ‰ name å­—æ®µï¼šéªŒè¯é€šè¿‡');
            } catch (error) {
                results.push(`âŒ æœ‰ name å­—æ®µï¼š${error.message}`);
            }

            // æµ‹è¯•æ²¡æœ‰ name å­—æ®µçš„æƒ…å†µ
            try {
                if (configWithoutName.method?.toUpperCase() === 'POST' || configWithoutName.method?.toUpperCase() === 'PUT') {
                    if (configWithoutName.data && typeof configWithoutName.data === 'object') {
                        if (configWithoutName.url?.includes('/datasources') && 
                            !configWithoutName.url?.includes('/datasources/test') && 
                            configWithoutName.data.name === undefined) {
                            throw new Error('æ•°æ®æºåç§°ä¸èƒ½ä¸ºç©º');
                        }
                    }
                }
                results.push('âŒ æ²¡æœ‰ name å­—æ®µï¼šåº”è¯¥æŠ›å‡ºé”™è¯¯ä½†æ²¡æœ‰');
            } catch (error) {
                results.push(`âœ… æ²¡æœ‰ name å­—æ®µï¼šæ­£ç¡®æŠ›å‡ºé”™è¯¯ - ${error.message}`);
            }

            resultDiv.innerHTML = `
                <div class="info">
                    <h4>ğŸ“‹ åˆ›å»ºæ•°æ®æºéªŒè¯æµ‹è¯•</h4>
                    <p><strong>æµ‹è¯•ç»“æœï¼š</strong></p>
                    <ul>
                        ${results.map(result => `<li>${result}</li>`).join('')}
                    </ul>
                    <p><strong>ç»“è®ºï¼š</strong> ä¿®å¤åçš„é€»è¾‘æ­£ç¡®åŒºåˆ†äº†æµ‹è¯•è¿æ¥å’Œåˆ›å»ºæ•°æ®æºçš„è¯·æ±‚</p>
                </div>
            `;
        }
    </script>
</body>
</html>