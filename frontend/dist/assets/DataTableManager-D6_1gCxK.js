import{e as P,f as T,g as m,w as J,c as I,a as e,k as R,l,j as _,o as C,_ as O,M as Q,i as h,t as E,L as g,v as L,m as x,y as H,B as U,h as Y,X as W,Y as Z,S as ee,a0 as te,$ as ae}from"./index-UzuFSHw5.js";import{u as q}from"./dataPreparation-DG379VK_.js";import{dataTableApi as $}from"./dataTableApi-BlCX55nQ.js";const le={class:"data-table-tree"},se={class:"search-section"},ne={class:"tree-section"},oe={key:0,"data-testid":"loading-indicator"},de={key:1,"data-testid":"empty-state"},ie=P({__name:"DataTableTree",props:{data:{},loading:{type:Boolean,default:!1},selectedTableId:{default:null}},emits:["select","refresh","syncTable","editTable","deleteTable","duplicateTable","exportTable"],setup(o,{emit:p}){const f=o,v=p,i=T(""),c=T();T(new Set);const s={children:"children",label:"label"};m(()=>f.data.filter(d=>d.type==="datasource").map(d=>d.id)),m(()=>{if(!i.value.trim())return f.data;const d=i.value.toLowerCase();return f.data.map(u=>{if(u.type==="datasource"){const w=(u.children||[]).filter(D=>D.label.toLowerCase().includes(d));if(w.length>0||u.label.toLowerCase().includes(d))return{...u,children:w}}return null}).filter(u=>u!==null)});const F=d=>{d.type==="table"&&d.tableId&&v("select",d.tableId)};return J(()=>f.selectedTableId,d=>{if(d&&c.value&&c.value.setCurrentKey){const u=D=>{for(const b of D){if(b.type==="table"&&b.tableId===d)return b;if(b.children&&b.children.length>0){const A=u(b.children);if(A)return A}}return null},w=u(f.data);w&&c.value.setCurrentKey(w.id)}}),(d,u)=>{const w=_("el-input"),D=_("el-tree"),b=_("el-skeleton"),A=_("el-empty");return C(),I("div",le,[e("div",se,[l(w,{modelValue:i.value,"onUpdate:modelValue":u[0]||(u[0]=M=>i.value=M),placeholder:"搜索数据表...","data-testid":"search-input"},null,8,["modelValue"])]),e("div",ne,[l(D,{ref_key:"treeRef",ref:c,data:o.data,props:s,"node-key":"id",onNodeClick:F,"data-testid":"tree-component"},null,8,["data"])]),o.loading?(C(),I("div",oe,[l(b,{rows:5})])):R("",!0),!o.loading&&o.data.length===0?(C(),I("div",de,[l(A,{description:"暂无数据表"})])):R("",!0)])}}}),re=O(ie,[["__scopeId","data-v-9815c06a"]]),z={getBySource(o){return $.getBySource(o)},getList(){return $.getList()},getById(o){return $.getById(o)},create(o){return $.create(o)},update(o){return $.update(o.id,o)},delete(o){return $.delete(o)},syncStructure(o){return $.syncStructure(o.table_name)},updateField(o,p,f){return $.updateField(o,p,f)},addField(o,p){return $.addField(o,p)},deleteField(o,p){return $.deleteField(o,p)}},ce={class:"data-table-detail"},ue={key:0,class:"loading-state","data-testid":"loading-state"},pe={key:1,class:"error-state","data-testid":"error-state"},fe={key:2,class:"detail-content"},_e={class:"table-info-section"},ve={class:"section-header"},me={class:"section-actions"},be={class:"info-grid"},ye={class:"info-item","data-testid":"table-info-item"},he={class:"info-value","data-testid":"table-name-value"},ge={class:"info-item","data-testid":"table-info-item"},Te={class:"info-value","data-testid":"source-name-value"},we={class:"info-item","data-testid":"table-info-item"},ke={class:"info-item","data-testid":"table-info-item"},Ce={class:"info-value","data-testid":"row-count-value"},$e={class:"info-item","data-testid":"table-info-item"},Ie={class:"info-value","data-testid":"field-count-value"},De={class:"info-item","data-testid":"table-info-item"},Ne={class:"info-value","data-testid":"created-at-value"},Ae={class:"info-item full-width","data-testid":"table-info-item"},Se={class:"info-value","data-testid":"description-value"},Ee={class:"fields-section"},xe={class:"section-header"},Be={class:"section-actions"},Le=P({__name:"DataTableDetail",props:{tableId:{type:String,required:!0}},setup(o){const p=q(),f=o,v=T(!0),i=T(null),c=T(!1),s=T(null);T(null),T(["VARCHAR","TEXT","INT","BIGINT","DECIMAL","DATE","DATETIME","TIMESTAMP","BOOLEAN","JSON","CHAR","FLOAT","DOUBLE","BLOB"]);const F=m(()=>s.value?s.value.tableName:""),d=m(()=>{const t=p.dataSources.data.find(a=>a.id===s.value?.sourceId);return t?t.name:"未知数据源"}),u=m(()=>s.value&&s.value.isActive?"success":"warning"),w=m(()=>s.value&&s.value.isActive?"激活":"未激活"),D=m(()=>s.value&&s.value.rowCount||0),b=m(()=>s.value&&s.value.fields&&s.value.fields.length||0),A=m(()=>s.value?s.value.createdAt:void 0),M=m(()=>s.value&&s.value.description),V=m(()=>s.value&&s.value.fields||[]),k=async()=>{v.value=!0,i.value=null;try{if(!f.tableId)throw new Error("缺少数据表ID");const t=await z.getById(Number(f.tableId)),a=t.columns?.map(r=>({id:r.id,name:r.name,displayName:r.name,type:r.type,isPrimaryKey:r.is_primary_key,isNullable:r.is_nullable,dictionaryCode:r.dictionary_code||null,description:r.description||null}))||[];s.value={id:t.id,tableName:t.table_name,sourceId:t.source_id,isActive:t.is_active||!1,rowCount:t.row_count||0,createdAt:t.created_at,updatedAt:t.updated_at,description:t.description||"",fields:a}}catch(t){i.value=t instanceof Error?t.message:"加载数据表详情失败",g.error(i.value)}finally{v.value=!1}},n=t=>t?new Date(t).toLocaleString("zh-CN"):"",N=t=>t.toLocaleString("zh-CN"),S=async()=>{if(s.value){c.value=!0;try{const t=await z.syncStructure({source_id:s.value.sourceId,table_name:s.value.tableName});await k(),g.success("表结构同步成功")}catch(t){const a=t instanceof Error?t.message:"同步表结构失败";g.error(a)}finally{c.value=!1}}},y=async()=>{if(s.value)try{const t=await z.addField(s.value.id,{name:"新字段",type:"VARCHAR",isNullable:!0,displayName:"新字段"});s.value.fields&&s.value.fields.push(t),g.success("字段添加成功")}catch(t){const a=t instanceof Error?t.message:"添加字段失败";g.error(a)}};return Q(()=>{k()}),(t,a)=>{const r=_("el-skeleton"),X=_("el-alert"),K=_("el-button"),j=_("el-tag"),B=_("el-table-column"),G=_("el-table");return C(),I("div",ce,[v.value?(C(),I("div",ue,[l(r,{rows:6,animated:""})])):i.value?(C(),I("div",pe,[l(X,{title:i.value,type:"error",closable:!1,"show-icon":""},null,8,["title"])])):(C(),I("div",fe,[e("div",_e,[e("div",ve,[a[1]||(a[1]=e("h3",{class:"section-title"},"基本信息",-1)),e("div",me,[l(K,{type:"primary",size:"small",onClick:S,loading:c.value,"data-testid":"sync-button"},{default:h(()=>[e("el-icon",null,[l(x(H))]),a[0]||(a[0]=L(" 同步表结构 ",-1))]),_:1},8,["loading"])])]),e("div",be,[e("div",ye,[a[2]||(a[2]=e("span",{class:"info-label"},"表名：",-1)),e("span",he,E(F.value),1)]),e("div",ge,[a[3]||(a[3]=e("span",{class:"info-label"},"数据源：",-1)),e("span",Te,E(d.value),1)]),e("div",we,[a[4]||(a[4]=e("span",{class:"info-label"},"状态：",-1)),l(j,{type:u.value,"data-testid":"status-tag"},{default:h(()=>[L(E(w.value),1)]),_:1},8,["type"])]),e("div",ke,[a[5]||(a[5]=e("span",{class:"info-label"},"记录数：",-1)),e("span",Ce,E(N(D.value)),1)]),e("div",$e,[a[6]||(a[6]=e("span",{class:"info-label"},"字段数：",-1)),e("span",Ie,E(b.value),1)]),e("div",De,[a[7]||(a[7]=e("span",{class:"info-label"},"创建时间：",-1)),e("span",Ne,E(n(A.value)),1)]),e("div",Ae,[a[8]||(a[8]=e("span",{class:"info-label"},"描述：",-1)),e("span",Se,E(M.value||"无"),1)])])]),e("div",Ee,[e("div",xe,[a[10]||(a[10]=e("h3",{class:"section-title"},"字段列表",-1)),e("div",Be,[l(K,{type:"primary",size:"small",onClick:y,disabled:!s.value,"data-testid":"add-field-button"},{default:h(()=>[e("el-icon",null,[l(x(U))]),a[9]||(a[9]=L(" 添加字段 ",-1))]),_:1},8,["disabled"])])]),l(G,{data:V.value,stripe:"",border:"",style:{width:"100%"},"data-testid":"fields-table"},{default:h(()=>[l(B,{prop:"name",label:"字段名",width:"150","data-testid":"field-header-name"}),l(B,{prop:"displayName",label:"显示名称",width:"150","data-testid":"field-header-display-name"}),l(B,{prop:"type",label:"数据类型",width:"120","data-testid":"field-header-type"}),l(B,{prop:"isPrimaryKey",label:"主键",width:"80",align:"center","data-testid":"field-header-primary-key"}),l(B,{prop:"isNullable",label:"可为空",width:"80",align:"center","data-testid":"field-header-nullable"}),l(B,{prop:"description",label:"描述","min-width":"150","data-testid":"field-header-description"})]),_:1},8,["data"])])]))])}}}),Fe=O(Le,[["__scopeId","data-v-e32b5f0b"]]),Me={class:"data-table-manager"},Ve={class:"page-header"},ze={class:"header-right"},Re={class:"main-content"},Pe={class:"left-panel"},Oe={class:"panel-header"},Ke={class:"panel-actions"},Qe={class:"panel-content"},He={class:"right-panel"},Ue={class:"panel-header"},qe={key:0,class:"panel-actions"},Xe={class:"panel-content"},je={key:1,class:"empty-state","data-testid":"empty-state"},Ge={class:"add-table-options"},Je={class:"option-content"},Ye={size:"32"},We={class:"option-content"},Ze={size:"32"},et={class:"option-content"},tt={size:"32"},at=P({__name:"DataTableManager",setup(o){const p=q(),f=T(!1),v=T(null),i=T(!1),c=m(()=>v.value?p.dataTables.data.find(k=>k.id===v.value):null),s=m(()=>F(p.dataTables.data,p.dataSources.data));function F(k,n){const N=[],S=new Map;return k.forEach(y=>{const t=y.sourceId;S.has(t)||S.set(t,[]),S.get(t).push(y)}),n.forEach(y=>{const t=S.get(y.id)||[],a={id:`source_${y.id}`,label:y.name,type:"datasource",sourceId:y.id,expanded:!0,children:t.map(r=>({id:`table_${r.id}`,label:r.displayName||r.name,type:"table",sourceId:y.id,tableId:r.id}))};N.push(a)}),N}const d=k=>{v.value=k},u=()=>{i.value=!0},w=()=>{i.value=!1,g.info("从数据库选择表功能将在后续任务中实现")},D=()=>{i.value=!1,g.info("Excel 导入功能将在后续任务中实现")},b=()=>{i.value=!1,g.info("SQL 建表功能将在后续任务中实现")},A=()=>{c.value&&g.info("编辑表功能将在后续任务中实现")},M=async()=>{if(c.value)try{await ae.confirm(`确定要删除数据表 "${c.value.displayName||c.value.name}" 吗？`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),g.info("删除表功能将在后续任务中实现")}catch{}},V=async()=>{f.value=!0;try{await p.fetchDataTables(),await p.fetchDataSources(),g.success("数据表列表已刷新")}catch(k){g.error("刷新数据表列表失败"),console.error("刷新数据表列表失败:",k)}finally{f.value=!1}};return Q(async()=>{await V()}),(k,n)=>{const N=_("el-button"),S=_("el-empty"),y=_("Database"),t=_("el-card"),a=_("el-dialog");return C(),I("div",Me,[e("div",Ve,[n[2]||(n[2]=e("div",{class:"header-left"},[e("h2",{class:"page-title"},"数据表管理"),e("p",{class:"page-description"},"管理数据源中的表结构和字段配置")],-1)),e("div",ze,[l(N,{type:"primary",onClick:u},{default:h(()=>[e("el-icon",null,[l(x(U))]),n[1]||(n[1]=L(" 添加数据表 ",-1))]),_:1})])]),e("div",Re,[e("div",Pe,[e("div",Oe,[n[3]||(n[3]=e("h3",null,"数据表列表",-1)),e("div",Ke,[l(N,{size:"small",onClick:V,loading:f.value,"data-testid":"refresh-button"},{default:h(()=>[e("el-icon",null,[l(x(H))])]),_:1},8,["loading"])])]),e("div",Qe,[l(re,{data:s.value,loading:f.value,"selected-table-id":v.value,onSelect:d,onRefresh:V,"data-testid":"data-table-tree"},null,8,["data","loading","selected-table-id"])])]),e("div",He,[e("div",Ue,[e("h3",null,E(c.value?c.value.name:"表详情"),1),c.value?(C(),I("div",qe,[l(N,{size:"small",onClick:A,"data-testid":"edit-table-button"},{default:h(()=>[e("el-icon",null,[l(x(W))]),n[4]||(n[4]=L(" 编辑 ",-1))]),_:1}),l(N,{size:"small",type:"danger",onClick:M,"data-testid":"delete-table-button"},{default:h(()=>[e("el-icon",null,[l(x(Z))]),n[5]||(n[5]=L(" 删除 ",-1))]),_:1})])):R("",!0)]),e("div",Xe,[v.value?(C(),Y(Fe,{"table-id":v.value,key:v.value,"data-testid":"data-table-detail"},null,8,["table-id"])):(C(),I("div",je,[l(S,{description:"请选择一个数据表查看详情"})]))])])]),l(a,{modelValue:i.value,"onUpdate:modelValue":n[0]||(n[0]=r=>i.value=r),title:"添加数据表",width:"600px","close-on-click-modal":!1,"data-testid":"add-table-dialog"},{default:h(()=>[e("div",Ge,[l(t,{class:"option-card",onClick:w,"data-testid":"add-from-database-option"},{default:h(()=>[e("div",Je,[e("el-icon",Ye,[l(y)]),n[6]||(n[6]=e("h4",null,"从数据库选择",-1)),n[7]||(n[7]=e("p",null,"从现有数据源中选择表进行导入",-1))])]),_:1}),l(t,{class:"option-card",onClick:D,"data-testid":"add-from-excel-option"},{default:h(()=>[e("div",We,[e("el-icon",Ze,[l(x(ee))]),n[8]||(n[8]=e("h4",null,"上传 Excel 文件",-1)),n[9]||(n[9]=e("p",null,"上传 Excel 文件并导入为数据表",-1))])]),_:1}),l(t,{class:"option-card",onClick:b,"data-testid":"add-from-sql-option"},{default:h(()=>[e("div",et,[e("el-icon",tt,[l(x(te))]),n[10]||(n[10]=e("h4",null,"执行 SQL 建表",-1)),n[11]||(n[11]=e("p",null,"通过 SQL 脚本创建新的数据表",-1))])]),_:1})])]),_:1},8,["modelValue"])])}}}),ot=O(at,[["__scopeId","data-v-2a4ffe2a"]]);export{ot as default};
