const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/dataTableApi-BlCX55nQ.js","assets/index-UzuFSHw5.js","assets/index-BnRZ5ZOD.css"])))=>i.map(i=>d[i]);
import{d as g,a1 as y}from"./index-UzuFSHw5.js";function d(a){return{data:a,loading:!1,error:null,lastUpdated:void 0}}function D(a=1,t=10,e=0){return{current:a,pageSize:t,total:e,showQuickJumper:!0,showSizeChanger:!0}}function b(){return{keyword:"",fields:[],filters:{},sortField:void 0,sortOrder:void 0}}function T(a="multiple"){return{selectedKeys:[],mode:a,selectAll:!1,indeterminate:!1}}function u(){return{visible:!1,title:void 0,data:void 0,mode:void 0,loading:!1}}function f(){return{data:[],expandedKeys:[],selectedKeys:[],checkedKeys:[],autoExpandParent:!0}}function l(){return{data:[],pagination:D(),search:b(),selection:T(),loading:!1,error:null}}async function h(a,t,e={}){const{clearError:s=!0,updateTimestamp:r=!0,onError:n,onSuccess:i}=e;a.loading=!0,s&&(a.error=null);try{const o=await t();return r&&(a.lastUpdated=new Date().toISOString()),i&&i(o),o}catch(o){const m=o.message||"操作失败";return a.error=m,n?n(o):console.error("Store operation error:",o),null}finally{a.loading=!1}}function S(a,t){return{add:async(e,s)=>{a.push(e);try{const r=await s(),n=a.findIndex(i=>t(i)===t(e));return n!==-1&&(a[n]=r),!0}catch(r){const n=a.findIndex(i=>t(i)===t(e));throw n!==-1&&a.splice(n,1),r}},update:async(e,s,r)=>{const n=a.findIndex(o=>t(o)===e);if(n===-1)return!1;const i={...a[n]};a[n]={...a[n],...s};try{const o=await r();return a[n]=o,!0}catch(o){throw a[n]=i,o}},remove:async(e,s)=>{const r=a.findIndex(i=>t(i)===e);if(r===-1)return!1;const n=a[r];a.splice(r,1);try{return await s(),!0}catch(i){throw a.splice(r,0,n),i}}}}function c(a){if(a===null||typeof a!="object")return a;if(a instanceof Date)return new Date(a.getTime());if(a instanceof Array)return a.map(t=>c(t));if(typeof a=="object"){const t={};for(const e in a)a.hasOwnProperty(e)&&(t[e]=c(a[e]));return t}return a}class p{snapshots=[];currentIndex=-1;maxSnapshots=50;save(t){this.snapshots=this.snapshots.slice(0,this.currentIndex+1),this.snapshots.push(c(t)),this.currentIndex++,this.snapshots.length>this.maxSnapshots&&(this.snapshots.shift(),this.currentIndex--)}undo(){return this.currentIndex>0?(this.currentIndex--,c(this.snapshots[this.currentIndex])):null}redo(){return this.currentIndex<this.snapshots.length-1?(this.currentIndex++,c(this.snapshots[this.currentIndex])):null}canUndo(){return this.currentIndex>0}canRedo(){return this.currentIndex<this.snapshots.length-1}clear(){this.snapshots=[],this.currentIndex=-1}}const v=g("dataPreparation",{state:()=>({dataSources:{...d([]),current:null,table:l()},dataTables:{...d([]),current:null,tree:f(),fields:l()},dictionaries:{...d([]),current:null,tree:f(),items:l()},relations:{...d([]),graph:{nodes:[],edges:[]},table:l()},ui:{activeTab:"datasource",modals:{dataSourceForm:u(),excelImport:u(),dictionaryForm:u(),relationForm:u()},snapshots:{dataSources:new p,dataTables:new p,dictionaries:new p,relations:new p}}}),getters:{activeDataSource:a=>a.dataSources.current,hasActiveDataSource:a=>a.dataSources.current!==null,dataSourceLoading:a=>a.dataSources.loading,dataSourcesData:a=>a.dataSources.data,currentDataTable:a=>a.dataTables.current,dataTablesLoading:a=>a.dataTables.loading,dataTablesData:a=>a.dataTables.data,getTablesBySourceId:a=>t=>a.dataTables.data.filter(e=>e.sourceId===t),currentDictionary:a=>a.dictionaries.current,dictionariesLoading:a=>a.dictionaries.loading,dictionariesData:a=>a.dictionaries.data,getDictionaryItems:a=>t=>a.dictionaries.data.find(s=>s.id===t)?.items||[],tableRelationsLoading:a=>a.relations.loading,tableRelationsData:a=>a.relations.data,getRelationsByTableId:a=>t=>a.relations.data.filter(e=>e.sourceTableId===t||e.targetTableId===t),canUndoDataSources:a=>a.ui.snapshots.dataSources.canUndo(),canRedoDataSources:a=>a.ui.snapshots.dataSources.canRedo(),canUndoDataTables:a=>a.ui.snapshots.dataTables.canUndo(),canRedoDataTables:a=>a.ui.snapshots.dataTables.canRedo(),canUndoDictionaries:a=>a.ui.snapshots.dictionaries.canUndo(),canRedoDictionaries:a=>a.ui.snapshots.dictionaries.canRedo(),canUndoRelations:a=>a.ui.snapshots.relations.canUndo(),canRedoRelations:a=>a.ui.snapshots.relations.canRedo()},actions:{async fetchDataSources(){return await h(this.dataSources,async()=>{console.log("fetchDataSources - 将在任务 6.1 中实现");const a=[];return this.dataSources.data=a,this.dataSources.table.data=a,a},{onSuccess:a=>{this.ui.snapshots.dataSources.save(a)}}).then(a=>({success:!0,data:a||[]}))},async createDataSource(a){const t=S(this.dataSources.data,r=>r.id),s={id:`temp_${Date.now()}`,name:a.name||"",sourceType:a.sourceType||"DATABASE",connectionStatus:"DISCONNECTED",isActive:!0,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),...a};try{return await t.add(s,async()=>(console.log("createDataSource - 将在任务 6.1 中实现",a),{...s,id:`ds_${Date.now()}`})),this.ui.snapshots.dataSources.save(this.dataSources.data),{success:!0,data:s}}catch(r){return{success:!1,message:r.message}}},async updateDataSource(a,t){const e=S(this.dataSources.data,s=>s.id);try{return await e.update(a,t,async()=>(console.log("updateDataSource - 将在任务 6.1 中实现",a,t),{...this.dataSources.data.find(n=>n.id===a),...t,updatedAt:new Date().toISOString()})),this.ui.snapshots.dataSources.save(this.dataSources.data),{success:!0,data:this.dataSources.data.find(r=>r.id===a)}}catch(s){return{success:!1,message:s.message}}},async deleteDataSource(a){const t=S(this.dataSources.data,e=>e.id);try{return await t.remove(a,async()=>{console.log("deleteDataSource - 将在任务 6.1 中实现",a)}),this.ui.snapshots.dataSources.save(this.dataSources.data),{success:!0}}catch(e){return{success:!1,message:e.message}}},async testConnection(a){return console.log("testConnection - 将在任务 6.1 中实现",a),{success:!0,data:{success:!1,message:"功能未实现"}}},async fetchDataTables(){return await h(this.dataTables,async()=>{console.log("fetchDataTables - 将在任务 6.1 中实现");const a=[];return this.dataTables.data=a,this.dataTables.tree.data=[],a},{onSuccess:a=>{this.ui.snapshots.dataTables.save(a)}}).then(a=>({success:!0,data:a||[]}))},async createDataTableFromDB(a){return console.log("createDataTableFromDB - 将在任务 6.1 中实现",a),{success:!1,message:"功能未实现"}},async importExcelFile(a,t){return console.log("importExcelFile - 将在任务 6.1 中实现",a,t),{success:!1,message:"功能未实现"}},async createTableFromSQL(a,t,e){try{const{dataTableApi:s}=await y(async()=>{const{dataTableApi:i}=await import("./dataTableApi-BlCX55nQ.js");return{dataTableApi:i}},__vite__mapDeps([0,1,2])),r=await s.createFromSql({sql:a,sourceId:t,tableName:e}),n={id:r.id||`table_${Date.now()}`,name:r.name||e||"SQL 创建的表",displayName:r.name||e||"SQL 创建的表",physicalName:r.name||e||"sql_table",sourceId:t,dataMode:"EXTRACT",fieldCount:r.fieldCount||0,rowCount:r.rowCount||0,status:"ENABLED",fields:[]};return this.dataTables.data.push(n),this.dataTables.table.data=this.dataTables.data,this.ui.snapshots.dataTables.save(this.dataTables.data),console.log("createTableFromSQL - 表创建成功",n),{success:!0,data:n}}catch(s){return console.error("createTableFromSQL - 创建失败",s),{success:!1,message:s.message||"SQL 执行失败"}}},async syncTableStructure(a){return console.log("syncTableStructure - 将在任务 6.1 中实现",a),{success:!1,message:"功能未实现"}},async fetchDictionaries(){return await h(this.dictionaries,async()=>{console.log("fetchDictionaries - 将在任务 6.1 中实现");const a=[];return this.dictionaries.data=a,this.dictionaries.tree.data=[],a},{onSuccess:a=>{this.ui.snapshots.dictionaries.save(a)}}).then(a=>({success:!0,data:a||[]}))},async fetchDictionaryItems(a){return console.log("fetchDictionaryItems - 将在任务 6.1 中实现",a),{success:!1,message:"功能未实现"}},async createDictionary(a){return console.log("createDictionary - 将在任务 6.1 中实现",a),{success:!1,message:"功能未实现"}},async importDictionaryItems(a,t){return console.log("importDictionaryItems - 将在任务 6.1 中实现",a,t),{success:!1,message:"功能未实现"}},async exportDictionaryItems(a,t){return console.log("exportDictionaryItems - 将在任务 6.1 中实现",a,t),{success:!1,message:"功能未实现"}},async fetchTableRelations(){return await h(this.relations,async()=>{console.log("fetchTableRelations - 将在任务 6.1 中实现");const a=[];return this.relations.data=a,this.relations.graph={nodes:[],edges:[]},a},{onSuccess:a=>{this.ui.snapshots.relations.save(a)}}).then(a=>({success:!0,data:a||[]}))},async createTableRelation(a){return console.log("createTableRelation - 将在任务 6.1 中实现",a),{success:!1,message:"功能未实现"}},async updateRelationGraph(a){return console.log("updateRelationGraph - 将在任务 6.1 中实现",a),{success:!1,message:"功能未实现"}},async exportRelationGraph(a){return console.log("exportRelationGraph - 将在任务 6.1 中实现",a),{success:!1,message:"功能未实现"}},setActiveTab(a){this.ui.activeTab=a},toggleModal(a,t,e){const s=this.ui.modals[a];t!==void 0?s.visible=t:s.visible=!s.visible,e!==void 0&&(s.data=e),s.visible||(s.data=void 0,s.mode=void 0,s.loading=!1)},setModalMode(a,t){this.ui.modals[a].mode=t},setModalLoading(a,t){this.ui.modals[a].loading=t},setCurrentDataSource(a){this.dataSources.current=a},setCurrentDataTable(a){this.dataTables.current=a},setCurrentDictionary(a){this.dictionaries.current=a},undoDataSources(){const a=this.ui.snapshots.dataSources.undo();a&&(this.dataSources.data=a,this.dataSources.table.data=a)},redoDataSources(){const a=this.ui.snapshots.dataSources.redo();a&&(this.dataSources.data=a,this.dataSources.table.data=a)},undoDataTables(){const a=this.ui.snapshots.dataTables.undo();a&&(this.dataTables.data=a)},redoDataTables(){const a=this.ui.snapshots.dataTables.redo();a&&(this.dataTables.data=a)},undoDictionaries(){const a=this.ui.snapshots.dictionaries.undo();a&&(this.dictionaries.data=a)},redoDictionaries(){const a=this.ui.snapshots.dictionaries.redo();a&&(this.dictionaries.data=a)},undoRelations(){const a=this.ui.snapshots.relations.undo();a&&(this.relations.data=a)},redoRelations(){const a=this.ui.snapshots.relations.redo();a&&(this.relations.data=a)},async batchDeleteDataSources(a){const e=(await Promise.allSettled(a.map(s=>this.deleteDataSource(s)))).filter(s=>s.status==="rejected").length;return e>0?{success:!1,message:`${e} 个数据源删除失败`}:{success:!0}},async batchTestConnections(a){const t=await Promise.allSettled(a.map(r=>{const n=this.dataSources.data.find(i=>i.id===r);return n?this.testConnection(n):Promise.reject("数据源不存在")})),e=t.filter(r=>r.status==="fulfilled").length,s=t.filter(r=>r.status==="rejected").length;return{success:!0,data:{success:e,failed:s}}},updateDataSourceSearch(a){Object.assign(this.dataSources.table.search,a)},updateDataTableSearch(a){Object.assign(this.dataTables.fields.search,a)},updateDictionarySearch(a){Object.assign(this.dictionaries.items.search,a)},updateRelationSearch(a){Object.assign(this.relations.table.search,a)},clearAllSnapshots(){this.ui.snapshots.dataSources.clear(),this.ui.snapshots.dataTables.clear(),this.ui.snapshots.dictionaries.clear(),this.ui.snapshots.relations.clear()},resetState(){this.dataSources.data=[],this.dataSources.current=null,this.dataSources.error=null,this.dataTables.data=[],this.dataTables.current=null,this.dataTables.error=null,this.dictionaries.data=[],this.dictionaries.current=null,this.dictionaries.error=null,this.relations.data=[],this.relations.error=null,this.ui.activeTab="datasource",Object.keys(this.ui.modals).forEach(a=>{const t=this.ui.modals[a];t.visible=!1,t.data=void 0,t.mode=void 0,t.loading=!1}),this.clearAllSnapshots()}}});export{v as u};
