<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API æ‹¦æˆªå™¨è°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; background: #f0f8f0; padding: 10px; border-radius: 3px; }
        .error { color: red; background: #fff0f0; padding: 10px; border-radius: 3px; }
        .info { color: blue; background: #f0f0ff; padding: 10px; border-radius: 3px; }
        button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>API æ‹¦æˆªå™¨è°ƒè¯•</h1>
    
    <div class="test-section">
        <h3>é—®é¢˜åˆ†æ</h3>
        <div class="info">
            <p><strong>ç°è±¡ï¼š</strong> å‰ç«¯ä»ç„¶æŠ¥"æ•°æ®æºåç§°ä¸èƒ½ä¸ºç©º"é”™è¯¯</p>
            <p><strong>å¯èƒ½åŸå› ï¼š</strong> frontend/src/services/api.ts ä¸­çš„è¯·æ±‚æ‹¦æˆªå™¨éªŒè¯é€»è¾‘</p>
            <p><strong>éªŒè¯æ–¹æ³•ï¼š</strong> ç›´æ¥æµ‹è¯•æ‹¦æˆªå™¨é€»è¾‘</p>
        </div>
    </div>

    <div class="test-section">
        <h3>æ‹¦æˆªå™¨é€»è¾‘æµ‹è¯•</h3>
        <button onclick="testInterceptorLogic()">æµ‹è¯•æ‹¦æˆªå™¨é€»è¾‘</button>
        <button onclick="testRequestData()">æµ‹è¯•è¯·æ±‚æ•°æ®ç»“æ„</button>
        <button onclick="testDirectAPI()">ç›´æ¥æµ‹è¯• API</button>
    </div>
    
    <div class="test-section">
        <h3>æµ‹è¯•ç»“æœ</h3>
        <div id="result"></div>
    </div>

    <script>
        function testInterceptorLogic() {
            const resultDiv = document.getElementById('result');
            
            // æ¨¡æ‹Ÿæ‹¦æˆªå™¨é€»è¾‘
            const config = {
                method: 'POST',
                url: '/api/datasources/test',
                data: {
                    name: 'demo_datasource',
                    source_type: 'DATABASE',
                    db_type: 'MySQL',
                    host: '127.0.0.1',
                    port: 3306,
                    database_name: 'mock_data',
                    auth_type: 'SQL_AUTH',
                    username: 'root',
                    password: 'password',
                    created_by: 'system'
                }
            };

            try {
                // æ¨¡æ‹Ÿæ‹¦æˆªå™¨éªŒè¯é€»è¾‘
                if (config.method?.toUpperCase() === 'POST' || config.method?.toUpperCase() === 'PUT') {
                    if (config.data && typeof config.data === 'object') {
                        // éªŒè¯å¿…å¡«å­—æ®µ
                        if (config.url?.includes('/datasources') && config.data.name === undefined) {
                            throw new Error('æ•°æ®æºåç§°ä¸èƒ½ä¸ºç©º');
                        }
                    }
                }

                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>âœ… æ‹¦æˆªå™¨é€»è¾‘æµ‹è¯•é€šè¿‡</h4>
                        <p><strong>URL:</strong> ${config.url}</p>
                        <p><strong>Method:</strong> ${config.method}</p>
                        <p><strong>Name å­—æ®µ:</strong> ${config.data.name}</p>
                        <p><strong>Name æ˜¯å¦ä¸º undefined:</strong> ${config.data.name === undefined}</p>
                        <p><strong>URL åŒ…å« /datasources:</strong> ${config.url?.includes('/datasources')}</p>
                        <p><strong>éªŒè¯ç»“æœ:</strong> é€šè¿‡ï¼Œä¸ä¼šæŠ›å‡ºé”™è¯¯</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ æ‹¦æˆªå™¨é€»è¾‘æµ‹è¯•å¤±è´¥</h4>
                        <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                        <p><strong>URL:</strong> ${config.url}</p>
                        <p><strong>Method:</strong> ${config.method}</p>
                        <p><strong>Name å­—æ®µ:</strong> ${config.data.name}</p>
                        <p><strong>Name æ˜¯å¦ä¸º undefined:</strong> ${config.data.name === undefined}</p>
                    </div>
                `;
            }
        }

        function testRequestData() {
            const resultDiv = document.getElementById('result');
            
            const requestData = {
                name: 'demo_datasource',
                source_type: 'DATABASE',
                db_type: 'MySQL',
                host: '127.0.0.1',
                port: 3306,
                database_name: 'mock_data',
                auth_type: 'SQL_AUTH',
                username: 'root',
                password: 'password',
                created_by: 'system'
            };

            resultDiv.innerHTML = `
                <div class="info">
                    <h4>ğŸ“‹ è¯·æ±‚æ•°æ®ç»“æ„åˆ†æ</h4>
                    <p><strong>æ•°æ®ç±»å‹:</strong> ${typeof requestData}</p>
                    <p><strong>æ˜¯å¦ä¸ºå¯¹è±¡:</strong> ${typeof requestData === 'object'}</p>
                    <p><strong>åŒ…å« name å­—æ®µ:</strong> ${'name' in requestData}</p>
                    <p><strong>name å­—æ®µå€¼:</strong> ${requestData.name}</p>
                    <p><strong>name æ˜¯å¦ä¸º undefined:</strong> ${requestData.name === undefined}</p>
                    <p><strong>name æ˜¯å¦ä¸ºç©ºå­—ç¬¦ä¸²:</strong> ${requestData.name === ''}</p>
                    <p><strong>name æ˜¯å¦ä¸º null:</strong> ${requestData.name === null}</p>
                    <p><strong>å®Œæ•´æ•°æ®:</strong></p>
                    <pre>${JSON.stringify(requestData, null, 2)}</pre>
                </div>
            `;
        }

        async function testDirectAPI() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>æ­£åœ¨æµ‹è¯•ç›´æ¥ API è°ƒç”¨...</p>';

            try {
                const requestData = {
                    name: 'demo_datasource',
                    source_type: 'DATABASE',
                    db_type: 'MySQL',
                    host: '127.0.0.1',
                    port: 3306,
                    database_name: 'mock_data',
                    auth_type: 'SQL_AUTH',
                    username: 'root',
                    password: 'password',
                    created_by: 'system'
                };

                console.log('å‘é€è¯·æ±‚æ•°æ®:', requestData);

                const response = await fetch('http://localhost:8000/api/datasources/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();
                console.log('å“åº”æ•°æ®:', data);

                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>âœ… ç›´æ¥ API è°ƒç”¨æˆåŠŸ</h4>
                            <p><strong>çŠ¶æ€ç :</strong> ${response.status}</p>
                            <p><strong>è¯´æ˜:</strong> ç»•è¿‡å‰ç«¯æ‹¦æˆªå™¨çš„ç›´æ¥è°ƒç”¨æˆåŠŸï¼Œè¯´æ˜åç«¯ API æ­£å¸¸</p>
                            <p><strong>å“åº”æ•°æ®:</strong></p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>âŒ ç›´æ¥ API è°ƒç”¨å¤±è´¥</h4>
                            <p><strong>çŠ¶æ€ç :</strong> ${response.status}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('è¯·æ±‚é”™è¯¯:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ ç›´æ¥ API è°ƒç”¨ç½‘ç»œé”™è¯¯</h4>
                        <p><strong>é”™è¯¯:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>