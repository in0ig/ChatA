# 数据准备模块用户手册

## 目录

- [数据源配置指南](#数据源配置指南)
- [数据表管理指南](#数据表管理指南)
- [字典表使用指南](#字典表使用指南)
- [常见问题解答](#常见问题解答)
- [最佳实践](#最佳实践)

---

## 数据源配置指南

### 支持的数据源类型

本系统支持以下数据源类型：

- **MySQL**：关系型数据库，用于存储结构化数据
- **Excel**：本地 Excel 文件（.xlsx/.xls 格式），用于临时数据导入

> **注意**：当前版本不支持 PostgreSQL。如需支持，请联系系统管理员。

### 连接参数配置说明

#### MySQL 数据源配置

| 参数 | 说明 | 示例值 |
|------|------|--------|
| 名称 | 数据源显示名称 | "销售数据库" |
| 类型 | 数据源类型，固定为 "mysql" | "mysql" |
| 主机 | MySQL 服务器地址 | "localhost" |
| 端口 | MySQL 服务端口 | "3306" |
| 数据库名 | 要连接的数据库名称 | "sales_db" |
| 用户名 | 数据库用户名 | "chatbi_user" |
| 密码 | 数据库密码 | "secure_password_123" |
| 字符集 | 数据库字符集 | "utf8mb4" |
| 是否激活 | 是否启用该数据源 | true |

#### Excel 数据源配置

| 参数 | 说明 | 示例值 |
|------|------|--------|
| 名称 | 数据源显示名称 | "销售报表" |
| 类型 | 数据源类型，固定为 "excel" | "excel" |
| 文件路径 | Excel 文件在服务器上的绝对路径 | "/public/uploads/sales.xlsx" |
| 是否激活 | 是否启用该数据源 | true |

### 连接测试步骤

1. 进入 **数据源管理** 页面
2. 点击 **添加数据源** 按钮
3. 填写对应数据源的配置信息
4. 点击 **测试连接** 按钮
5. 系统将显示连接结果：
   - 成功：显示 "连接成功！"
   - 失败：显示具体错误信息（如网络超时、认证失败等）
6. 确认无误后，点击 **保存**

### 常见连接问题解决方案

| 问题现象 | 可能原因 | 解决方案 |
|----------|----------|----------|
| 连接超时 | MySQL 服务未启动或网络不通 | 1. 检查 MySQL 服务是否运行：`brew services list mysql`<br>2. 检查防火墙设置<br>3. 使用 `telnet localhost 3306` 测试端口连通性 |
| 认证失败 | 用户名或密码错误 | 1. 核对数据库账号密码<br>2. 检查用户是否具有访问指定数据库的权限<br>3. 尝试使用 MySQL 客户端手动连接验证 |
| 数据库不存在 | 输入的数据库名不正确 | 1. 登录 MySQL 客户端，执行 `SHOW DATABASES;` 查看可用数据库<br>2. 确保输入的数据库名完全匹配（区分大小写） |
| 文件路径无效（Excel） | 文件不存在或路径错误 | 1. 确认文件已上传至 `/public/uploads/` 目录<br>2. 检查路径拼写是否正确<br>3. 避免使用中文或特殊字符路径 |
| 权限不足 | 用户无访问权限 | 1. 联系 DBA 授予用户 `SELECT` 权限<br>2. 对于 Excel 文件，确保文件可读（权限 644） |

> **提示**：连接失败时，系统会记录详细错误日志到 `logs/backend_*.log`，可协助排查问题。

---

## 数据表管理指南

### 数据表创建流程

1. **上传 Excel 文件**（如适用）
   - 将 Excel 文件上传至服务器 `/public/uploads/` 目录
   - 或通过前端界面直接上传

2. **分析文件结构**
   - 在数据表管理页面，点击 **从 Excel 导入**
   - 选择上传的文件和 Sheet 名称
   - 系统自动分析列名、数据类型和示例数据

3. **生成表结构**
   - 系统根据 Excel 数据自动生成推荐的表结构
   - 可手动修改字段名、类型、是否为主键等

4. **创建数据表**
   - 点击 **创建表** 按钮
   - 系统在数据库中创建对应的数据表
   - 表名格式：`dt_{id}`，如 `dt_123`

5. **导入数据**
   - 创建表后，点击 **导入数据** 按钮
   - 系统异步执行数据导入，支持大文件
   - 可在 **导入任务** 页面查看进度

### Excel 文件导入步骤

1. 在 **数据表管理** 页面，点击 **从 Excel 导入**
2. 选择文件（支持 .xlsx 和 .xls）
3. 选择要导入的 Sheet（如 "Sheet1"）
4. 设置数据起始行（通常为第 2 行，第 1 行为标题）
5. 选择是否自动创建表（推荐首次导入勾选）
6. 选择是否替换已有同名表（谨慎使用）
7. 点击 **开始导入**
8. 等待导入完成，查看结果

### 表结构同步功能

当 Excel 文件内容变更时，可使用 **同步表结构** 功能：

1. 在数据表列表中，找到目标表
2. 点击 **同步结构** 按钮
3. 系统重新分析 Excel 文件，对比当前表结构
4. 显示差异（新增/删除/修改的字段）
5. 选择要应用的变更
6. 点击 **确认同步**

> **注意**：同步操作可能影响现有数据，请提前备份。

### 字段配置和管理

- **字段重命名**：在表详情页，点击字段名进行编辑
- **字段类型修改**：支持修改为 `string`、`integer`、`float`、`date`、`boolean`
- **设置主键**：选择一个字段作为主键（仅支持单字段）
- **设置非空**：标记字段为必填项
- **添加注释**：为字段添加说明，便于团队协作
- **删除字段**：谨慎操作，删除后数据不可恢复

> **字段命名规范**：推荐使用小写英文，单词间用下划线分隔（如 `customer_name`）

---

## 字典表使用指南

### 字典表概念和作用

字典表用于标准化数据值，解决数据不一致问题，例如：

- 性别："男"、"女"、"M"、"F" → 统一为 "男"、"女"
- 状态："已支付"、"paid"、"1" → 统一为 "已支付"

字典表支持多级分类，如：

```
客户类型
├── 企业客户
├── 个人客户
└── 政府客户
```

### 创建和管理字典

1. 进入 **数据字典** 页面
2. 点击 **新建字典**
3. 填写字典名称（如 "客户类型"）
4. 选择字典类型（单级或树形）
5. 点击 **保存**

### 字典项的增删改查

- **添加字典项**：在字典详情页，点击 **添加项**，填写值和标签
- **编辑字典项**：点击项右侧的编辑图标，修改值或标签
- **删除字典项**：点击删除图标，系统提示确认
- **排序**：拖拽项调整顺序，或输入排序值

> **重要**：字典项的值（value）必须唯一，标签（label）可重复。

### 导入导出功能使用

#### 导出字典

1. 在字典列表页，点击 **导出**
2. 选择导出格式：CSV 或 JSON
3. 系统生成文件并自动下载

#### 导入字典

1. 在字典列表页，点击 **导入**
2. 选择已导出的 CSV 或 JSON 文件
3. 系统解析文件，显示预览
4. 确认映射关系（如 value → 值，label → 标签）
5. 点击 **确认导入**

> **导入规则**：
> - CSV 格式：第一行为表头（`value`, `label`, `parent_id`）
> - JSON 格式：数组结构，每个对象包含 `value`, `label`, `parent_id`

---

## 常见问题解答

### Excel 文件格式要求

- **支持格式**：`.xlsx`、`.xls`
- **不支持格式**：`.csv`、`.ods`、`.xlsm`
- **文件大小**：建议不超过 50MB
- **编码要求**：文件必须使用 UTF-8 编码（Excel 默认支持）
- **Sheet 要求**：每个文件只能包含一个有效数据 Sheet
- **标题行**：第一行必须为列标题，不能为空
- **数据行**：从第二行开始为数据，不能有空行

### 数据类型映射规则

| Excel 数据示例 | 系统自动识别类型 | 说明 |
|----------------|------------------|------|
| 123, 456 | `integer` | 整数 |
| 123.45, 0.001 | `float` | 浮点数 |
| "2026-01-30" | `date` | 符合 YYYY-MM-DD 格式 |
| "2026/01/30" | `string` | 格式不标准，无法识别为日期 |
| "是", "否" | `boolean` | 自动映射为 true/false |
| "abc", "用户1" | `string` | 文本 |
| 空单元格 | `null` | 允许为空 |

### 性能优化建议

- **小文件（<5MB）**：直接导入，无需异步
- **大文件（>10MB）**：务必使用异步导入，避免前端超时
- **字段类型**：尽量使用 `integer`、`boolean` 而非 `string`，提升查询性能
- **索引**：对高频查询字段（如日期、ID）手动添加索引
- **并发**：避免同时导入多个大文件，建议排队处理
- **内存**：确保服务器内存充足，建议 ≥4GB

### 错误排查指南

| 错误提示 | 排查步骤 |
|----------|----------|
| "文件不存在" | 1. 检查文件是否上传成功<br>2. 检查路径是否正确<br>3. 查看 `logs/backend_*.log` 中的上传记录 |
| "表名已存在" | 1. 检查是否已存在同名表<br>2. 删除旧表或使用新表名<br>3. 检查数据源是否正确 |
| "字段类型不支持" | 1. 检查 Excel 中是否有混合类型数据<br>2. 清理空行和合并单元格<br>3. 手动指定字段类型 |
| "导入失败，无权限" | 1. 检查数据库用户权限<br>2. 检查文件读取权限<br>3. 联系管理员授予 `INSERT` 和 `CREATE` 权限 |
| "连接超时" | 1. 检查网络连接<br>2. 检查 MySQL 是否运行<br>3. 尝试重启服务 |

---

## 最佳实践

### 数据准备工作流程

1. **准备阶段**：收集并整理 Excel 文件，确保格式规范
2. **分析阶段**：使用系统分析文件结构，确认字段语义
3. **设计阶段**：规划数据表结构，确定主键和索引
4. **创建阶段**：创建数据表，配置字段和字典映射
5. **导入阶段**：异步导入数据，监控进度
6. **验证阶段**：抽样检查数据准确性，确认无误
7. **发布阶段**：激活数据表，通知用户使用

### 命名规范建议

| 对象 | 规范 | 示例 |
|------|------|------|
| 数据源名称 | 中文描述，清晰易懂 | "销售订单数据库" |
| 数据表名 | 小写英文，下划线分隔 | `sales_orders` |
| 字段名 | 小写英文，下划线分隔 | `order_date`, `customer_id` |
| 字典名 | 中文描述，明确范围 | "客户类型"、"订单状态" |
| 字典值 | 英文小写，下划线分隔 | `enterprise_customer`, `paid` |
| 字典标签 | 中文描述，用户友好 | "企业客户"、"已支付" |

### 安全注意事项

- **文件上传**：仅允许上传 `.xlsx` 和 `.xls` 文件，防止恶意脚本
- **路径限制**：Excel 文件必须存储在 `/public/uploads/` 目录，禁止访问系统文件
- **权限控制**：数据源连接信息加密存储，禁止明文暴露
- **SQL 注入**：所有查询使用参数化语句，防止注入攻击
- **日志脱敏**：敏感字段（如密码）不在日志中记录
- **定期清理**：定期清理 `/public/uploads/` 中的过期文件

### 维护和监控

- **监控指标**：
  - 每日导入任务数量
  - 导入成功率
  - 平均导入耗时
  - 数据表活跃数量
- **日志检查**：
  - 每日检查 `logs/backend_*.log` 中的错误信息
  - 关注 `ERROR` 和 `WARNING` 级别日志
- **备份策略**：
  - 数据表结构和字典定期导出备份
  - 数据库每日全量备份
- **版本控制**：
  - 所有数据准备操作均记录操作人和时间
  - 支持回滚到历史版本（计划中）

> **建议**：建立数据准备操作审核流程，重要变更需双人复核。

---

> **截图占位符**：
> - 数据源配置界面：![数据源配置界面](screenshots/datasource-config.png)
> - 数据表管理界面：![数据表管理界面](screenshots/datatable-management.png)
> - 字典表管理界面：![字典表管理界面](screenshots/dictionary-management.png)
> - Excel 导入向导：![Excel 导入向导](screenshots/excel-import-wizard.png)

> **文档版本**：v1.0.0<br>
> **最后更新**：2026-01-30


