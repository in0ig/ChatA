<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯æ•°æ®æºæ˜¾ç¤ºæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .datasource-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background-color: #f9f9f9;
        }
        .datasource-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }
        .datasource-name {
            font-weight: bold;
            font-size: 18px;
            color: #333;
        }
        .datasource-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-active {
            background-color: #d4edda;
            color: #155724;
        }
        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }
        .datasource-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .detail-item {
            display: flex;
            justify-content: space-between;
        }
        .detail-label {
            font-weight: bold;
            color: #666;
        }
        .detail-value {
            color: #333;
        }
        .highlight {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å‰ç«¯æ•°æ®æºæ˜¾ç¤ºæµ‹è¯•</h1>
        <p>æµ‹è¯•å‰ç«¯æ˜¯å¦èƒ½æ­£ç¡®æ˜¾ç¤ºåç«¯åˆ›å»ºçš„æ•°æ®æºè®°å½•</p>

        <div class="test-section info">
            <h3>ğŸ¯ æµ‹è¯•ç›®æ ‡</h3>
            <ul>
                <li>âœ… éªŒè¯å‰ç«¯APIèƒ½æ­£ç¡®è°ƒç”¨åç«¯æ•°æ®æºåˆ—è¡¨æ¥å£</li>
                <li>âœ… éªŒè¯æ•°æ®æ ¼å¼è½¬æ¢æ˜¯å¦æ­£ç¡®</li>
                <li>âœ… éªŒè¯å‰ç«¯èƒ½æ­£ç¡®æ˜¾ç¤ºæ•°æ®æºä¿¡æ¯</li>
                <li>âœ… ç‰¹åˆ«å…³æ³¨æ–°åˆ›å»ºçš„"å‰ç«¯å±•ç¤ºæ•°æ®æº"</li>
            </ul>
        </div>

        <div class="highlight">
            <strong>ğŸ” é‡ç‚¹éªŒè¯:</strong> åç«¯å·²æˆåŠŸåˆ›å»ºäº†åä¸º"å‰ç«¯å±•ç¤ºæ•°æ®æº"çš„MySQLæ•°æ®æºï¼Œè¿æ¥åˆ°mock_dataæ•°æ®åº“ã€‚
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æ•°æ®æºåˆ—è¡¨</h3>
            <button onclick="loadDataSources()">ğŸ”„ åŠ è½½æ•°æ®æºåˆ—è¡¨</button>
            <button onclick="testFrontendAPI()">ğŸ§ª æµ‹è¯•å‰ç«¯API</button>
            <div id="dataSourceList">
                <p>ç‚¹å‡»"åŠ è½½æ•°æ®æºåˆ—è¡¨"æŒ‰é’®å¼€å§‹æµ‹è¯•...</p>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ APIè°ƒç”¨è¯¦æƒ…</h3>
            <pre id="apiDetails">ç­‰å¾…APIè°ƒç”¨...</pre>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ åŸå§‹æ•°æ®</h3>
            <pre id="rawData">ç­‰å¾…æ•°æ®åŠ è½½...</pre>
        </div>
    </div>

    <script>
        let apiLog = '';

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            apiLog += `[${timestamp}] ${message}\n`;
            document.getElementById('apiDetails').textContent = apiLog;
        }

        function showDataSources(dataSources) {
            const container = document.getElementById('dataSourceList');
            
            if (!dataSources || dataSources.length === 0) {
                container.innerHTML = '<div class="error">æ²¡æœ‰æ‰¾åˆ°æ•°æ®æº</div>';
                return;
            }

            let html = `<div class="success">
                <h4>âœ… æˆåŠŸåŠ è½½ ${dataSources.length} ä¸ªæ•°æ®æº</h4>
            </div>`;

            dataSources.forEach((ds, index) => {
                const isTarget = ds.name === 'å‰ç«¯å±•ç¤ºæ•°æ®æº';
                const cardClass = isTarget ? 'datasource-card highlight' : 'datasource-card';
                
                html += `
                <div class="${cardClass}">
                    <div class="datasource-header">
                        <div class="datasource-name">
                            ${ds.name} ${isTarget ? 'ğŸ¯ (ç›®æ ‡æ•°æ®æº)' : ''}
                        </div>
                        <div class="datasource-status status-${ds.status}">
                            ${ds.status === 'active' ? 'æ´»è·ƒ' : 'éæ´»è·ƒ'}
                        </div>
                    </div>
                    <div class="datasource-details">
                        <div class="detail-item">
                            <span class="detail-label">ID:</span>
                            <span class="detail-value">${ds.id}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ç±»å‹:</span>
                            <span class="detail-value">${ds.type}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ä¸»æœº:</span>
                            <span class="detail-value">${ds.config.host}:${ds.config.port}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">æ•°æ®åº“:</span>
                            <span class="detail-value">${ds.config.database}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ç”¨æˆ·å:</span>
                            <span class="detail-value">${ds.config.username}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">åˆ›å»ºæ—¶é—´:</span>
                            <span class="detail-value">${new Date(ds.createdAt).toLocaleString()}</span>
                        </div>
                    </div>
                </div>`;
            });

            container.innerHTML = html;
        }

        async function loadDataSources() {
            log('å¼€å§‹åŠ è½½æ•°æ®æºåˆ—è¡¨...');
            
            try {
                log('å‘é€è¯·æ±‚åˆ°: /api/datasources/');
                
                const response = await fetch('/api/datasources/', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });

                log(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    const result = await response.json();
                    log(`åŸå§‹å“åº”æ•°æ®: ${JSON.stringify(result, null, 2)}`);
                    
                    // æ˜¾ç¤ºåŸå§‹æ•°æ®
                    document.getElementById('rawData').textContent = JSON.stringify(result, null, 2);
                    
                    // è½¬æ¢æ•°æ®æ ¼å¼ï¼ˆæ¨¡æ‹Ÿå‰ç«¯APIçš„è½¬æ¢é€»è¾‘ï¼‰
                    const transformedData = result.data.map(item => ({
                        id: item.id,
                        name: item.name,
                        type: item.db_type === 'MySQL' ? 'mysql' : 'sqlserver',
                        config: {
                            host: item.host,
                            port: item.port,
                            database: item.database_name,
                            username: item.username,
                            password: '********',
                            connectionPool: {
                                min: 5,
                                max: 20,
                                timeout: 30
                            }
                        },
                        status: item.status ? 'active' : 'inactive',
                        createdAt: new Date(item.created_at),
                        updatedAt: new Date(item.updated_at)
                    }));

                    log(`è½¬æ¢åçš„æ•°æ®: ${JSON.stringify(transformedData, null, 2)}`);
                    log(`æ‰¾åˆ° ${transformedData.length} ä¸ªæ•°æ®æº`);
                    
                    // æ£€æŸ¥æ˜¯å¦åŒ…å«ç›®æ ‡æ•°æ®æº
                    const targetDataSource = transformedData.find(ds => ds.name === 'å‰ç«¯å±•ç¤ºæ•°æ®æº');
                    if (targetDataSource) {
                        log('âœ… æˆåŠŸæ‰¾åˆ°ç›®æ ‡æ•°æ®æº: "å‰ç«¯å±•ç¤ºæ•°æ®æº"');
                    } else {
                        log('âŒ æœªæ‰¾åˆ°ç›®æ ‡æ•°æ®æº: "å‰ç«¯å±•ç¤ºæ•°æ®æº"');
                    }
                    
                    showDataSources(transformedData);
                } else {
                    const errorText = await response.text();
                    log(`é”™è¯¯å“åº”: ${errorText}`);
                    document.getElementById('dataSourceList').innerHTML = 
                        `<div class="error">åŠ è½½å¤±è´¥: ${response.status} ${response.statusText}</div>`;
                }
            } catch (error) {
                log(`ç½‘ç»œé”™è¯¯: ${error.message}`);
                document.getElementById('dataSourceList').innerHTML = 
                    `<div class="error">ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
            }
        }

        async function testFrontendAPI() {
            log('æµ‹è¯•å‰ç«¯APIå…¼å®¹æ€§...');
            
            // æ¨¡æ‹Ÿå‰ç«¯APIè°ƒç”¨é€»è¾‘
            try {
                const response = await fetch('/api/datasources/', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const backendData = await response.json();
                    
                    // è¿™æ˜¯å‰ç«¯APIä¸­çš„è½¬æ¢é€»è¾‘
                    const transformedData = {
                        data: backendData.data.map((item) => ({
                            id: item.id,
                            name: item.name,
                            type: item.db_type === 'MySQL' ? 'mysql' : 'sqlserver',
                            config: {
                                host: item.host,
                                port: item.port,
                                database: item.database_name,
                                username: item.username,
                                password: '********',
                                connectionPool: {
                                    min: 5,
                                    max: 20,
                                    timeout: 30
                                }
                            },
                            status: item.status ? 'active' : 'inactive',
                            createdAt: new Date(item.created_at),
                            updatedAt: new Date(item.updated_at)
                        })),
                        total: backendData.total
                    };

                    log('âœ… å‰ç«¯APIè½¬æ¢é€»è¾‘æµ‹è¯•æˆåŠŸ');
                    log(`è½¬æ¢ç»“æœ: ${JSON.stringify(transformedData, null, 2)}`);
                    
                    showDataSources(transformedData.data);
                } else {
                    log(`âŒ å‰ç«¯APIæµ‹è¯•å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                log(`âŒ å‰ç«¯APIæµ‹è¯•é”™è¯¯: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®æº
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆ');
            log('åç«¯æœåŠ¡: http://localhost:8000');
            log('å‰ç«¯æœåŠ¡: http://localhost:5173');
            log('å‡†å¤‡æµ‹è¯•æ•°æ®æºæ˜¾ç¤ºåŠŸèƒ½...');
            
            // è‡ªåŠ¨åŠ è½½æ•°æ®æº
            setTimeout(loadDataSources, 1000);
        };
    </script>
</body>
</html>